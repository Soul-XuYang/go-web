<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>åŠ¨æ€åœ°å›¾å¯»è·¯æŒ‘æˆ˜</title>
    <link rel="stylesheet" href="/static/base.css" />
    <style>
        :root {
            --muted: #7d9ac2;
            --cell: 24px;
            --primary: #3b82f6;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans SC";
            background: #f5f7fb;
            color: #0f172a;
        }

        .top {
            max-width: 1400px;
            margin: 16px auto 12px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand h1 {
            margin: 0;
            font-size: 1.3rem;
        }

        .userbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(0, 0, 0, .06);
            background: rgba(255, 255, 255, .9);
        }

        .avatar {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: var(--primary);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }

        .uname {
            color: var(--muted);
            font-size: .95rem;
        }

        /* ä¸‰åˆ—æ”¹ç”¨ flexï¼ˆå·¦è‡ªé€‚åº”ï¼Œä¸­å³å›ºå®šï¼‰ */
        .wrap {
            max-width: 1400px;
            margin: 16px auto 8px;
            padding: 0 16px;
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }

        .card--mapXL {
            flex: 1 1 0;
            min-width: 320px;
        }

        .card--controls {
            flex: 0 0 380px;
            max-width: 380px;
            min-width: 280px;
        }

        .card--stats {
            flex: 0 0 320px;
            max-width: 320px;
            min-width: 240px;
        }

        .card {
            border: 1px solid rgba(0, 0, 0, .06);
            border-radius: 16px;
            background: #fff;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(2, 6, 23, .06);
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .card h2 {
            margin: 0;
            font-size: 1.15rem;
        }

        .sub {
            margin: 0 0 8px;
            color: rgba(0, 0, 0, 0.856);
            font-size: .96rem;
            line-height: 2.0;
        }

        /* åœ°å›¾å®¹å™¨ â€”â€” é‡è¦ï¼š width:100% + overflow:autoï¼Œé˜²æ­¢æ’‘å¼€å…¶ä»–åˆ— */
        .map-container {
            position: relative;
            background: rgba(0, 0, 0, .03);
            border: 1px solid rgba(0, 0, 0, .04);
            border-radius: 12px;
            padding: 16px;
            min-height: 360px;
            max-height: 75vh;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: auto;
            /* è¶…å‡ºæ—¶æ»šåŠ¨ï¼Œä¸ä¼šæŠŠåˆ«çš„åˆ—æ¨å¼€ */
            width: 100%;
        }

        /* map-grid: æ³¨æ„ width ä¸ grid-template-columns ä¼šè¢« JS åŠ¨æ€è®¾ç½® */
        .map-grid {
            display: grid;
            gap: 2px;
            border-radius: 8px;
            padding: 8px;
            border: 1px solid rgba(0, 0, 0, .06);
            max-width: 100%;
            width: max-content;
            /* æ ¹æ®æ ¼å­æ•°é‡è‡ªé€‚åº”å®½åº¦ */
        }

        /* å½“ mapGrid ä¸­æ’å…¥æç¤ºæ¶ˆæ¯ .msg æ—¶ï¼Œè®©å®ƒè·¨åˆ—å¹¶å æ»¡ */
        .map-grid>.msg {
            grid-column: 1 / -1;
            width: 100%;
            box-sizing: border-box;
        }

        .map-cell {
            width: var(--cell);
            height: var(--cell);
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            border: 1px solid rgba(0, 0, 0, .06);
            transition: all .2s ease;
            position: relative;
            background: #f8fafc;
        }

        .map-cell.wall {
            background: #1f2937;
            border-color: #374151;
            color: transparent;
        }

        .map-cell.path {
            background: #e6edf7;
            border-color: #dbe6f6;
            color: #6b7280;
        }

        .map-cell.start {
            background: #10b981;
            color: #fff;
            border-color: #059669;
        }

        .map-cell.player {
            background: #3b82f6;
            color: #fff;
            border-color: #2563eb;
            animation: pulse 1.5s infinite;
        }

        .map-cell.visited {
            background: #eef2ff;
            border-color: #dbeafe;
            color: #6b7280;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }

        .map-controls {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0, 0, 0, .06);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: .75rem;
            color: #374151;
        }

        .game-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-game {
            flex: 1;
            height: 44px;
            min-width: 110px;
            border-radius: 10px;
            font-weight: 600;
            font-size: .92rem;
            border: none;
            cursor: pointer
        }

        .btn-start {
            background: var(--primary);
            color: #fff;
        }

        .btn-reset {
            background: #f59e0b;
            color: #fff;
        }

        .stat {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .chip {
            border: 1px solid rgba(0, 0, 0, .06);
            background: rgba(0, 0, 0, 0.02);
            padding: 5px 10px;
            border-radius: 999px;
            font-size: .85rem;
        }

        .msg {
            padding: 10px 12px;
            border-radius: 10px;
            line-height: 1.5;
            background: rgba(0, 0, 0, 0.02);
            border: 1px solid rgba(0, 0, 0, 0.04);
            min-height: 44px;
            font-size: .9rem;
            word-break: break-word;
            white-space: normal;
        }

        .msg.success {
            border-color: rgba(34, 197, 94, .25);
            background: rgba(34, 197, 94, .06);
        }

        .msg.info {
            border-color: rgba(59, 130, 246, .18);
            background: rgba(59, 130, 246, .03);
        }

        .progress {
            height: 10px;
            border-radius: 999px;
            overflow: hidden;
            background: rgba(0, 0, 0, 0.03);
            border: 1px solid rgba(0, 0, 0, 0.04);
        }

        .bar {
            height: 100%;
            width: 0%;
            background: var(--primary);
            transition: width .25s ease;
        }

        hr {
            border: none;
            height: 1px;
            background: rgba(0, 0, 0, 0.04);
            margin: 12px 0;
        }

        .time-display {
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            margin: 4px 0;
        }

        .current-time {
            color: #10b981
        }

        .total-time {
            color: #f59e0b
        }

        .time-label {
            font-size: .88rem;
            color: var(--muted);
            margin-bottom: 2px;
        }

        /* æ–¹å‘é”®ï¼šæ”¹æˆ gridï¼Œgrid-area ç²¾ç¡®å®šä½ */
        .movement-controls {
            margin: 0;
            padding: 12px;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 10px;
            border: 1px solid rgba(0, 0, 0, 0.04);
        }

        .movement-controls h3 {
            margin: 0 0 10px;
            font-size: .95rem;
            text-align: center;
            color: #0f172a;
        }

        .direction-pad {
            display: grid;
            grid-template-columns: 56px 56px 56px;
            grid-template-rows: 56px 56px 56px;
            grid-template-areas:
                ". up ."
                "left center right"
                ". down .";
            gap: 8px;
            justify-content: center;
            align-items: center;
            max-width: 220px;
            margin: 0 auto;
        }

        .btn-up {
            grid-area: up;
        }

        .btn-down {
            grid-area: down;
        }

        .btn-left {
            grid-area: left;
        }

        .btn-right {
            grid-area: right;
        }

        .center-indicator {
            grid-area: center;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            padding: 8px;
            background: rgba(59, 130, 246, 0.08);
            border-radius: 8px;
            border: 1px solid rgba(59, 130, 246, 0.12);
        }

        .btn-direction {
            width: 56px;
            height: 56px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            border: 2px solid rgba(0, 0, 0, 0.06);
            background: #fff;
            color: #0f172a;
            cursor: pointer;
        }

        .btn-direction:disabled {
            opacity: .45;
            cursor: not-allowed;
        }

        .map-legend {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            padding: 8px 10px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.02);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: .85rem;
            color: var(--muted);
        }

        .below {
            max-width: 1400px;
            margin: 8px auto 24px;
            padding: 0 16px;
            display: flex;
            justify-content: center;
            gap: 24px;
        }

        .below .btn-primary {
            height: 44px;
            min-width: 160px;
            border-radius: 10px;
            font-size: .92rem;
            background: var(--primary);
            color: #fff;
            border: none;
            cursor: pointer;
        }

        /* å“åº”å¼ï¼šçª„å±æ—¶æ”¹ä¸ºç«–åˆ— */
        @media (max-width:1100px) {
            .wrap {
                flex-direction: column;
                gap: 14px;
                padding: 0 12px;
            }

            .card--controls,
            .card--stats {
                flex: 1 1 auto;
                max-width: 100%;
            }

            .card--mapXL {
                max-width: 100%
            }

            .direction-pad {
                grid-template-columns: 44px 44px 44px;
                grid-template-rows: 44px 44px 44px;
                gap: 6px;
            }

            .btn-direction {
                width: 44px;
                height: 44px;
            }
        }

        @media (max-width:600px) {
            .map-cell {
                width: 18px;
                height: 18px;
                font-size: 11px;
            }

            .btn-game {
                min-width: 100px;
                height: 40px;
            }

            .map-container {
                min-height: 320px;
                max-height: 60vh;
                padding: 12px;
            }

            .card {
                padding: 14px;
                gap: 8px;
            }

            .card h2 {
                font-size: 1.05rem;
            }
        }
    </style>
</head>

<body>
    <header class="top">
        <div class="brand">
            <h1>åœ°å›¾å¯»è·¯æŒ‘æˆ˜</h1>
        </div>
        <div class="userbox">
            <div class="avatar" id="avatar">U</div><span class="uname" id="username">åŠ è½½ä¸­â€¦</span>
        </div>
    </header>

    <main class="wrap">
        <!-- å·¦ï¼šåœ°å›¾ï¼ˆè‡ªé€‚åº”ï¼‰ -->
        <section class="card card--mapXL">
            <h2>åœ°å›¾æ˜¾ç¤ºåŒº</h2>
            åœ°å›¾æ¸¸æˆè§„åˆ™ï¼š
            <ul style="color:var(--muted);font-size:.9rem;line-height:1.6;">
                ç”¨æˆ·ç§»åŠ¨è“è‰²ç©å®¶>(ğŸ”µ)ä»èµ·ç‚¹å‡ºå‘ï¼Œæ¢ç´¢åœ°å›¾ï¼ŒæŠµè¾¾éšè—ç»ˆç‚¹(å®é™…ä¸Šæ˜¯å¯»æ‰¾ç¦»èµ·ç‚¹æœ€è¿œçš„æœ‰æ•ˆç‚¹)å³è‡ªåŠ¨å®Œæˆæœ¬è½®ã€‚
            </ul>
            <div class="map-legend">
                <span class="legend-item"><span class="legend-wall">â–ˆ</span> éšœç¢ç‰©</span>
                <span class="legend-item"><span class="legend-path">Â·</span> å¯èµ°è·¯å¾„</span>
                <span class="legend-item"><span class="legend-start">+</span> èµ·ç‚¹</span>
                <span class="legend-item"><span class="legend-player">ğŸ”µ</span> ç©å®¶</span>
            </div>

            <div class="map-container">
                <div class="map-controls">æ–¹å‘é”®/æŒ‰é’®ç§»åŠ¨ | æŠµè¾¾ç»ˆç‚¹è‡ªåŠ¨è®°å½•</div>
                <div id="mapDisplay" class="map-grid">
                    <div class="msg info">ç‚¹å‡»â€œå¼€å§‹æ¸¸æˆâ€ç”Ÿæˆåœ°å›¾</div>
                </div>
            </div>

            <div id="feedback" class="msg info">è¯·ç‚¹å‡»â€œå¼€å§‹æ¸¸æˆâ€æŒ‰é’®å¼€å§‹ç¬¬ 1 è½®æŒ‘æˆ˜ã€‚</div>
        </section>

        <!-- ä¸­ï¼šæ¸¸æˆæ§åˆ¶ -->
        <section class="card card--controls">
            <h2>æ¸¸æˆæ§åˆ¶</h2>
            <div class="game-controls">
                <button id="btnStart" class="btn-game btn-start">å¼€å§‹æ¸¸æˆ</button>
                <button id="btnReset" class="btn-game btn-reset">é‡ç½®æ¸¸æˆ</button>
            </div>

            <div class="movement-controls">
                <h3>ç§»åŠ¨æ§åˆ¶</h3>
                <!-- ç»“æ„è°ƒæ•´ï¼šæ–¹å‘é”®ä¸ centerIndicator éƒ½æ˜¯ direction-pad çš„ç›´æ¥å­å…ƒç´  -->
                <div class="direction-pad" aria-hidden="false">
                    <button id="btnUp" class="btn-direction btn-up" disabled>â†‘</button>
                    <button id="btnLeft" class="btn-direction btn-left" disabled>â†</button>
                    <div class="center-indicator">ğŸ”µ</div>
                    <button id="btnRight" class="btn-direction btn-right" disabled>â†’</button>
                    <button id="btnDown" class="btn-direction btn-down" disabled>â†“</button>
                </div>
                <small
                    style="color:var(--muted);font-size:.8rem;text-align:center;display:block;margin-top:6px;">ä¹Ÿå¯ä½¿ç”¨é”®ç›˜æ–¹å‘é”®æ§åˆ¶</small>
            </div>

            <div class="stat">
                <span class="chip">å½“å‰è½®æ¬¡ï¼š<b id="roundText">â€”</b></span>
                <span class="chip">éš¾åº¦ç­‰çº§ï¼š<b id="difficultyText">â€”</b></span>
                <span class="chip">åœ°å›¾å¤§å°ï¼š<b id="sizeText">â€”</b></span>
                <span class="chip">è·¯å¾„è·ç¦»ï¼š<b id="distanceText">â€”</b></span>
            </div>

            <div class="progress">
                <div id="bar" class="bar"></div>
            </div>
            <small style="color:var(--muted);font-size:.82rem;">è¿›åº¦æ¡æ˜¾ç¤ºï¼šå½“å‰è½®æ¬¡ / æ€»è½®æ¬¡ (3 è½®)</small>

            <hr />
            <div>
                <div class="time-label">æœ¬è½®ç”¨æ—¶ï¼ˆå®æ—¶ï¼‰</div>
                <div class="time-display current-time" id="currentTime">00:00</div>
                <div class="time-label">ä¸‰è½®æ€»ç”¨æ—¶</div>
                <div class="time-display total-time" id="totalTime">00:00</div>
                <button id="gotoDisplay" class="btn-primary"
                    style="width:100%; height:42px; border-radius:10px; font-size:.9rem;">æ¸¸æˆåœ°å›¾çš„å¯è§†åŒ–å±•ç¤º</button>
            </div>
        </section>

        <!-- å³ï¼šä¸ªäººç»Ÿè®¡ -->
        <section class="card card--stats">
            <h2>ä¸ªäººç»Ÿè®¡</h2>
            <div class="stat">
                <span class="chip">å†å²æœ€ä½³ï¼š<b id="myBest">â€”</b></span>
                <span class="chip">å½“å‰æ’åï¼š<b id="myRank">â€”</b></span>
            </div>
            <hr />
            <div class="stat"><span class="chip muted">æ¸¸æˆè¯´æ˜ï¼š</span></div>
            <ul style="color:var(--muted);font-size:.9rem;line-height:1.6;">
                <li>ä¸‰è½®æŒ‘æˆ˜ï¼Œéš¾åº¦é€’å¢ï¼ˆ8Ã—8 â†’ 12Ã—12 â†’ 16Ã—16ï¼‰</li>
                <li>éšè—ç»ˆç‚¹ï¼ŒæŠµè¾¾å³è‡ªåŠ¨å®Œæˆæœ¬è½®</li>
                <li>ç”¨æ—¶è¶ŠçŸ­æ’åè¶Šé«˜ï¼Œç¬¬ä¸‰è½®ç»“æŸè‡ªåŠ¨ä¿å­˜æˆç»©</li>
            </ul>
            <div class="stat" style="margin-top:8px;">
                <button id="gotoRanks" class="btn-primary"
                    style="width:100%; height:42px; border-radius:10px; font-size:.9rem;">æŸ¥çœ‹æ’è¡Œæ¦œ</button>
                <button id="backHome" class="btn-primary"
                    style="width:100%; height:42px; border-radius:10px; font-size:.9rem;">è¿”å›ä¸»èœå•</button>
            </div>
        </section>
    </main>


    <script>
        // ====== åŸºç¡€å°è£… ======
        const $ = s => document.querySelector(s);
        const API_ME = '/api/me';
        const API_MAP_START = '/api/game/map/start';
        const API_MAP_COMPLETE = '/api/game/map/complete';
        const API_MAP_RESET = '/api/game/map/reset';
        const API_MYBEST = '/api/game/leaderboard/me?game=map_game';

        function getStoredToken() {
            const t = localStorage.getItem('token');
            if (!t) return null;
            return t.toLowerCase().startsWith('bearer ') ? t : ('Bearer ' + t);
        }
        async function authFetch(url, opts = {}) {
            const token = getStoredToken();
            const headers = Object.assign({ 'Content-Type': 'application/json' }, token ? { 'Authorization': token } : {}, opts.headers || {});
            const r = await fetch(url, { credentials: 'include', ...opts, headers });
            if (r.status === 401) { localStorage.removeItem('token'); location.href = '/auth/login'; throw new Error('Unauthorized'); }
            return r;
        }

        function initialOf(name) { if (!name) return 'U'; const s = String(name).trim(); return s ? s[0].toUpperCase() : 'U'; }
        async function loadMe() {
            try {
                const r = await authFetch(API_ME);
                const d = await r.json().catch(() => ({}));
                const uname = d.username || d.name || 'unknown';
                $('#username').textContent = uname; $('#avatar').textContent = initialOf(uname);
                return { id: d.user_id || d.id || 0, name: uname };
            } catch { return { id: 0, name: '' }; }
        }

        // ====== æ¸¸æˆçŠ¶æ€ ======
        const gameState = { round: 0, difficulty: 0, size: 0, isActive: false, startTime: null, totalTime: 0, mapData: null, startPoint: null, endPoint: null, playerPos: null, visitedCells: new Set(), completing: false };
        let currentTimeInterval = null;

        // ====== æ—¶é—´æ˜¾ç¤º ======
        const pad2 = n => String(n).padStart(2, '0');
        function formatTime(seconds) { const m = Math.floor(seconds / 60), s = Math.floor(seconds % 60); return `${pad2(m)}:${pad2(s)}`; }
        function updateCurrentTime() { if (!gameState.isActive || !gameState.startTime) return; const elapsed = (Date.now() - gameState.startTime) / 1000; $('#currentTime').textContent = formatTime(elapsed); }
        function startTimer() { gameState.startTime = Date.now(); currentTimeInterval = setInterval(updateCurrentTime, 1000); }
        function stopTimer() { if (currentTimeInterval) { clearInterval(currentTimeInterval); currentTimeInterval = null; } }

        // è‡ªé€‚åº”æ ¼å­
        function fitCellSize(size) {
            const container = document.querySelector('.map-container'); if (!container) return;
            const inner = container.clientWidth - 40;
            const usable = inner - (16 + 2) - (size - 1) * 2;
            let cell = Math.floor(usable / size);
            cell = Math.max(18, Math.min(cell, 32));
            document.documentElement.style.setProperty('--cell', cell + 'px');
        }

        // ====== åœ°å›¾æ¸²æŸ“ï¼ˆmapData: string[]ï¼‰ ======
        function renderMap(mapData, startPoint, endPoint) {
            if (!mapData || !mapData.length) { console.error('åœ°å›¾æ•°æ®ä¸ºç©ºæˆ–æ— æ•ˆ'); return; }
            const size = mapData.length;
            const mapDisplay = $('#mapDisplay');
            fitCellSize(size);
            // è®¾ç½®åˆ—æ•°ï¼Œä»¥ä¾¿ grid æ­£ç¡®å¸ƒå±€æ ¼å­
            mapDisplay.style.gridTemplateColumns = `repeat(${size}, var(--cell))`;
            mapDisplay.style.gridAutoRows = `var(--cell)`;
            mapDisplay.innerHTML = '';

            gameState.mapData = mapData; gameState.startPoint = startPoint; gameState.endPoint = endPoint;
            gameState.playerPos = { x: startPoint.x, y: startPoint.y }; gameState.visitedCells.clear(); gameState.size = size;

            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'map-cell';
                    cell.dataset.row = i; cell.dataset.col = j;
                    const ch = mapData[i][j];
                    if (i === startPoint.x && j === startPoint.y) { cell.classList.add('start', 'player'); cell.textContent = 'ğŸ”µ'; }
                    else if (ch === 'o' || ch === 'x' || ch === '+') { cell.classList.add('path'); cell.textContent = 'Â·'; }
                    else { cell.classList.add('wall'); cell.textContent = 'â–ˆ'; }
                    mapDisplay.appendChild(cell);
                }
            }
            enableMovementButtons();
        }

        // æ¸…ç©ºåœ°å›¾å¹¶æ˜¾ç¤ºæç¤ºï¼šé‡ç½® gridTemplateColumnsï¼ˆé˜²æ­¢ç«–æ’ï¼‰
        function clearMapWithTip(tip) {
            const mapDisplay = $('#mapDisplay');
            // 1) é‡ç½®åˆ—è®¾ç½®ï¼Œç¡®ä¿æç¤ºä¸æ˜¯è¢«é™åˆ¶åœ¨å°åˆ—å®½é‡Œ
            mapDisplay.style.gridTemplateColumns = '';
            mapDisplay.style.gridAutoRows = '';
            mapDisplay.innerHTML = `<div class="msg info">${tip}</div>`;
        }

        function enableMovementButtons() { $('#btnUp').disabled = false; $('#btnDown').disabled = false; $('#btnLeft').disabled = false; $('#btnRight').disabled = false; }
        function disableMovementButtons() { $('#btnUp').disabled = true; $('#btnDown').disabled = true; $('#btnLeft').disabled = true; $('#btnRight').disabled = true; }

        // ====== ç§»åŠ¨ ======
        async function movePlayer(direction) {
            if (!gameState.isActive || !gameState.playerPos || gameState.completing) return;
            const { x, y } = gameState.playerPos;
            let nx = x, ny = y;
            if (direction === 'up') nx = x - 1;
            if (direction === 'down') nx = x + 1;
            if (direction === 'left') ny = y - 1;
            if (direction === 'right') ny = y + 1;
            if (nx < 0 || nx >= gameState.size || ny < 0 || ny >= gameState.size) return;
            const ch = gameState.mapData[nx][ny];
            const isEnd = (nx === gameState.endPoint.x && ny === gameState.endPoint.y);
            const isStartNew = (nx === gameState.startPoint.x && ny === gameState.startPoint.y);
            if (ch !== 'o' && ch !== 'x' && !isStartNew && !isEnd) return;

            const old = document.querySelector(`[data-row="${x}"][data-col="${y}"]`);
            const wasStart = (x === gameState.startPoint.x && y === gameState.startPoint.y);
            if (old) {
                old.classList.remove('player');
                if (!wasStart) { old.classList.add('visited'); old.textContent = 'Â·'; }
                else { old.textContent = '+'; }
                gameState.visitedCells.add(`${x},${y}`);
            }

            gameState.playerPos = { x: nx, y: ny };
            const now = document.querySelector(`[data-row="${nx}"][data-col="${ny}"]`);
            if (now) { now.classList.add('player'); now.textContent = 'ğŸ”µ'; }

            if (isEnd) {
                gameState.isActive = false; gameState.completing = true;
                disableMovementButtons();
                $('#feedback').className = 'msg success';
                $('#feedback').textContent = 'åˆ°è¾¾ç»ˆç‚¹ï¼Œæ­£åœ¨è®°å½•æˆç»©â€¦';
                try { await completeRound(); } finally { gameState.completing = false; }
            }
        }

        function setupKeyboardControls() {
            const handler = (e) => {
                if (!gameState.isActive || gameState.completing) return;
                switch (e.key) {
                    case 'ArrowUp': e.preventDefault(); movePlayer('up'); break;
                    case 'ArrowDown': e.preventDefault(); movePlayer('down'); break;
                    case 'ArrowLeft': e.preventDefault(); movePlayer('left'); break;
                    case 'ArrowRight': e.preventDefault(); movePlayer('right'); break;
                }
            };
            document.addEventListener('keydown', handler, { passive: false });
        }

        // ====== æµç¨‹ï¼ˆä¸åç«¯äº¤äº’ä¿æŒä¸å˜ï¼‰ ======
        async function startGame() {
            try {
                $('#btnStart').disabled = true;
                $('#feedback').className = 'msg info'; $('#feedback').textContent = 'æ­£åœ¨ç”Ÿæˆåœ°å›¾â€¦';
                const r = await authFetch(API_MAP_START, { method: 'POST' });
                const d = await r.json();

                gameState.round = d.round; gameState.difficulty = d.difficulty; gameState.size = d.size;
                gameState.isActive = true; gameState.completing = false;

                $('#roundText').textContent = d.round;
                $('#difficultyText').textContent = getDifficultyName(d.difficulty);
                $('#sizeText').textContent = `${d.size}Ã—${d.size}`;
                $('#distanceText').textContent = d.currentDistance;
                $('#totalTime').textContent = formatTime(d.totalTime);

                renderMap(d.mapData, d.startPoint, d.endPoint);

                const progress = (d.round / 3) * 100;
                $('#bar').style.width = progress + '%';
                startTimer();

                $('#feedback').className = 'msg info';
                $('#feedback').textContent = (d.message || 'åœ°å›¾å·²ç”Ÿæˆã€‚') + ' ä½¿ç”¨æ–¹å‘é”®æˆ–æŒ‰é’®ç§»åŠ¨ï¼ŒæŠµè¾¾ç»ˆç‚¹è‡ªåŠ¨å®Œæˆæœ¬è½®ã€‚';
            } catch (e) {
                $('#feedback').className = 'msg'; $('#feedback').textContent = 'å¼€å§‹æ¸¸æˆå¤±è´¥ï¼š' + (e?.message || 'è¯·ç¨åå†è¯•');
            } finally { $('#btnStart').disabled = false; }
        }

        async function completeRound() {
            try {
                stopTimer();
                const r = await authFetch(API_MAP_COMPLETE, { method: 'POST' });
                const d = await r.json().catch(() => ({}));
                if (!r.ok) throw new Error(d?.error || d?.message || ('HTTP ' + r.status));

                gameState.totalTime = d.totalTime;
                $('#totalTime').textContent = formatTime(d.totalTime);
                $('#currentTime').textContent = formatTime(d.roundTime);

                let suffix = '';
                if (d.gameComplete) suffix = d.saved ? 'ï¼ˆå·²ä¿å­˜åˆ°æ’è¡Œæ¦œï¼‰' : 'ï¼ˆæœªèƒ½ä¿å­˜åˆ°æ’è¡Œæ¦œï¼Œè¯·æŸ¥çœ‹åç«¯æ—¥å¿—ï¼‰';
                else suffix = 'ï¼ˆå·²å®Œæˆæœ¬è½®ï¼‰';

                $('#feedback').className = 'msg success';
                $('#feedback').textContent = (d.message || 'æœ¬è½®å®Œæˆã€‚') + suffix;

                // æ¸…ç©ºåœ°å›¾å¹¶æç¤ºï¼ˆç°åœ¨ä¼šå®Œæ•´æ¨ªå‘æ˜¾ç¤ºï¼Œä¸ä¼šç«–æ’ï¼‰
                clearMapWithTip(d.gameComplete ? 'æ¸¸æˆå·²å®Œæˆï¼Œç‚¹å‡»â€œå¼€å§‹æ¸¸æˆâ€å¼€å¯æ–°ä¸€å±€' : 'æœ¬è½®å·²å®Œæˆï¼Œç‚¹å‡»â€œå¼€å§‹æ¸¸æˆâ€è¿›å…¥ä¸‹ä¸€è½®');

                disableMovementButtons();
                gameState.isActive = false;

                if (d.gameComplete) {
                    gameState.round = 0;
                    $('#roundText').textContent = 'â€”';
                    $('#difficultyText').textContent = 'â€”';
                    $('#sizeText').textContent = 'â€”';
                    $('#distanceText').textContent = 'â€”';
                    $('#bar').style.width = '0%';
                    await loadMyBest();
                }
            } catch (e) {
                $('#feedback').className = 'msg'; $('#feedback').textContent = 'è®°å½•æˆç»©å¤±è´¥ï¼š' + (e?.message || 'è¯·ç¨åå†è¯•');
                gameState.isActive = true; enableMovementButtons();
            }
        }

        async function resetGame() {
            try {
                stopTimer();
                $('#btnReset').disabled = true;
                const r = await authFetch(API_MAP_RESET, { method: 'POST' });
                let d = {}; try { d = await r.json(); } catch { }
                if (!r.ok) throw new Error(d?.error || d?.message || ('HTTP ' + r.status));

                gameState.isActive = false; gameState.completing = false; gameState.round = 0; gameState.totalTime = 0;
                gameState.mapData = null; gameState.startPoint = null; gameState.endPoint = null; gameState.playerPos = null; gameState.visitedCells.clear();

                $('#roundText').textContent = 'â€”'; $('#difficultyText').textContent = 'â€”'; $('#sizeText').textContent = 'â€”'; $('#distanceText').textContent = 'â€”';
                $('#currentTime').textContent = '00:00'; $('#totalTime').textContent = '00:00'; $('#bar').style.width = '0%';
                clearMapWithTip('æ¸¸æˆå·²é‡ç½®ï¼Œç‚¹å‡»â€œå¼€å§‹æ¸¸æˆâ€é‡æ–°å¼€å§‹');

                $('#feedback').className = 'msg info'; $('#feedback').textContent = d?.message || 'å½“å‰ç”¨æˆ·çš„åœ°å›¾æ¸¸æˆçŠ¶æ€å·²é‡ç½®ï¼Œå¯ä»¥é‡æ–°å¼€å§‹æ¸¸æˆ';
                disableMovementButtons();
            } catch (e) { $('#feedback').className = 'msg'; $('#feedback').textContent = 'é‡ç½®æ¸¸æˆå¤±è´¥ï¼š' + (e?.message || 'è¯·ç¨åå†è¯•'); }
            finally { $('#btnReset').disabled = false; }
        }

        function getDifficultyName(d) { return d === 0 ? 'ç®€å•' : d === 1 ? 'ä¸­ç­‰' : d === 2 ? 'å›°éš¾' : 'â€”'; }

        async function loadMyBest() {
            try {
                const r = await authFetch(API_MYBEST);
                const d = await r.json().catch(() => ({}));
                if (!r.ok) throw new Error(d?.error || d?.message || ('HTTP ' + r.status));
                const best = Number(d.best ?? d.score ?? 0);
                const rank = Number(d.rank ?? 0);
                $('#myBest').textContent = (isFinite(best) && best > 0) ? formatTime(best) : 'â€”';
                $('#myRank').textContent = (rank > 0) ? ('#' + rank) : 'æœªä¸Šæ¦œ';
            } catch (e) {
                $('#myBest').textContent = 'â€”'; $('#myRank').textContent = 'â€”';
            }
        }

        // äº‹ä»¶ç»‘å®š
        $('#btnStart').onclick = startGame;
        $('#btnReset').onclick = resetGame;
        $('#btnUp').onclick = () => movePlayer('up');
        $('#btnDown').onclick = () => movePlayer('down');
        $('#btnLeft').onclick = () => movePlayer('left');
        $('#btnRight').onclick = () => movePlayer('right');
        $('#backHome').onclick = () => location.href = '/page/shell';
        $('#gotoDisplay').onclick = () => location.href = '/page/game/map/display';
        $('#gotoRanks').onclick = () => location.href = '/page/game/leaderboards';

        (async function init() {
            await loadMe();
            await loadMyBest();
            setupKeyboardControls();
            disableMovementButtons();
        })();
    </script>
</body>

</html>1