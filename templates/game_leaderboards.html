<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>游戏排行榜</title>
    <link rel="stylesheet" href="/static/base.css" />
    <style>
        :root {
            --muted: #94a3b8;
            --card-min: 360px;
            --card-gap: 20px;
            --card-pad: 24px;
            --card-min-h: 240px;
        }

        body {
            margin: 0;
        }

        .top {
            max-width: 960px;
            margin: 20px auto 12px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand h1 {
            margin: 0;
            font-size: 1.75rem;
        }

        .userbox {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, .12);
            background: rgba(255, 255, 255, .04);
        }

        .avatar {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: .8rem;
            font-weight: 700;
            letter-spacing: .5px;
        }

        .uname {
            color: var(--muted);
            font-size: .95rem;
        }

        .toolbar {
            max-width: 960px;
            margin: 6px auto 0;
            padding: 0 16px;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-primary {
            background: var(--primary);
            border-color: var(--primary);
            color: #fff;
        }

        .wrap {
            max-width: 960px;
            padding: 0 16px;
            margin: 20px auto 24px;
            display: grid;
            gap: var(--card-gap);
            grid-template-columns: repeat(auto-fit, minmax(var(--card-min), 1fr));
            align-items: stretch;
        }

        .card {
            padding: var(--card-pad);
            min-height: var(--card-min-h);
            border: 1px solid rgba(255, 255, 255, .12);
            border-radius: 16px;
            background: rgba(255, 255, 255, .03);
            box-shadow: 0 10px 30px rgba(2, 6, 23, .16);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .card h2 {
            margin: 0;
            font-size: 1.18rem;
        }

        .sub {
            margin: 0;
            color: var(--muted);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
        }

        .table th,
        .table td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, .08);
            text-align: left;
            font-size: .95rem;
        }

        .table th {
            color: var(--muted);
            font-weight: 600;
        }

        .score {
            text-align: right;
            font-variant-numeric: tabular-nums;
        }

        .rank-badge {
            display: inline-block;
            min-width: 28px;
            text-align: center;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 999px;
            background: rgba(255, 255, 255, .06);
        }

        .rank-1 {
            background: #f59e0b;
            color: #1f2937;
        }

        /* 金 */
        .rank-2 {
            background: #9ca3af;
            color: #111827;
        }

        /* 银 */
        .rank-3 {
            background: #d97706;
            color: #111827;
        }

        /* 铜 */
        .me {
            background: rgba(59, 130, 246, .12);
        }

        /* 当前用户高亮行 */

        .empty {
            color: var(--muted);
            text-align: center;
            padding: 16px 0;
        }

        .footer {
            max-width: 960px;
            margin: 0 auto 24px;
            padding: 0 16px;
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .footer .btn-primary {
            height: 56px;
            min-width: 160px;
            border-radius: 12px;
        }
    </style>
</head>

<body>
    <!-- 顶部 -->
    <header class="top">
        <div class="brand">
            <h1>游戏排行榜</h1>
        </div>
        <div class="userbox">
            <div class="avatar" id="avatar">U</div>
            <span class="uname" id="username">加载中…</span>
        </div>
    </header>

    <!-- 工具栏 -->
    <div class="toolbar">
        <button id="btnRefresh" class="btn-primary">刷新排行榜</button>
    </div>

    <!-- 排行卡片容器 -->
    <main class="wrap" id="boardWrap">
        <!-- JS 动态插入每个游戏的排行榜卡片 -->
    </main>

    <!-- 底部 -->
    <div class="footer">
        <button id="backHome" class="btn-primary">返回主菜单</button>
        <button id="logout" class="btn-primary">退出登录</button>
    </div>

    <script>
        (function () {
            const $ = s => document.querySelector(s);
            const wrap = $('#boardWrap');

            // 和后端的 gameCode 映射到展示标题
            const GAME_TITLES = {
                'guess_game': '数字猜猜乐 · Top 10',
                // 以后加更多：'snake': '贪吃蛇 · Top 10', ...
            };

            function bind(id, handler) {
                const el = document.getElementById(id);
                if (el) el.addEventListener('click', handler);
            }

            function getStoredToken() {
                const t = localStorage.getItem('token');
                if (!t) return null;
                return t.toLowerCase().startsWith('bearer ') ? t : ('Bearer ' + t);
            }

            async function authFetch(url, opts = {}) {
                const token = getStoredToken();
                const headers = Object.assign(
                    { 'Content-Type': 'application/json' },
                    token ? { 'Authorization': token } : {},
                    opts.headers || {}
                );
                const r = await fetch(url, { credentials: 'include', ...opts, headers });
                if (r.status === 401) {
                    localStorage.removeItem('token');
                    location.href = '/auth/login';
                    throw new Error('Unauthorized');
                }
                return r;
            }

            function initialOf(name) {
                if (!name) return 'U';
                const s = String(name).trim();
                return s ? s[0].toUpperCase() : 'U';
            }

            async function loadMe() {
                try {
                    const r = await authFetch('/api/me');
                    const d = await r.json().catch(() => ({}));
                    const uname = d.username || d.name || 'unknown';
                    $('#username').textContent = uname;
                    $('#avatar').textContent = initialOf(uname);
                    return { id: d.user_id || d.id || 0, name: uname };
                } catch (e) {
                    console.error('加载用户信息失败：', e);
                    return { id: 0, name: '' };
                }
            }

            function titleByCode(code) {
                return GAME_TITLES[code] || (code + ' · Top 10');
            }

            function renderCard(gameCode, items, currentUID) {
                const card = document.createElement('section');
                card.className = 'card';

                const h2 = document.createElement('h2');
                h2.textContent = titleByCode(gameCode);

                const sub = document.createElement('p');
                sub.className = 'sub';
                sub.textContent = '展示 Redis ZSET 的前 10 名（按分数降序）。';

                card.appendChild(h2);
                card.appendChild(sub);

                if (!items || items.length === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'empty';
                    empty.textContent = '暂无上榜数据';
                    card.appendChild(empty);
                    return card;
                }

                const table = document.createElement('table');
                table.className = 'table';

                const thead = document.createElement('thead');
                thead.innerHTML = `
      <tr>
        <th style="width:88px;">名次</th>
        <th>用户</th>
        <th class="score">分数</th>
      </tr>`;
                table.appendChild(thead);

                const tbody = document.createElement('tbody');

                for (const row of items) {
                    const tr = document.createElement('tr');
                    if (currentUID && row.user_id === currentUID) tr.classList.add('me');

                    const tdRank = document.createElement('td');
                    const badge = document.createElement('span');
                    badge.className = 'rank-badge';
                    badge.textContent = '#' + row.rank;
                    if (row.rank === 1) badge.classList.add('rank-1');
                    else if (row.rank === 2) badge.classList.add('rank-2');
                    else if (row.rank === 3) badge.classList.add('rank-3');
                    tdRank.appendChild(badge);

                    const tdUser = document.createElement('td');
                    tdUser.textContent = row.username || String(row.user_id);

                    const tdScore = document.createElement('td');
                    tdScore.className = 'score';
                    tdScore.textContent = row.score;

                    tr.appendChild(tdRank);
                    tr.appendChild(tdUser);
                    tr.appendChild(tdScore);
                    tbody.appendChild(tr);
                }

                table.appendChild(tbody);
                card.appendChild(table);
                return card;
            }

            async function loadBoards() {
                wrap.innerHTML = ''; // 清空
                const me = await loadMe();

                let data;
                try {
                    const r = await authFetch('/api/game/leaderboards');
                    data = await r.json();
                } catch (e) {
                    console.error('读取排行榜失败：', e);
                    const errCard = document.createElement('section');
                    errCard.className = 'card';
                    errCard.innerHTML = `<h2>读取失败</h2><p class="sub">请稍后再试。</p>`;
                    wrap.appendChild(errCard);
                    return;
                }

                const boards = (data && data.leaderboards) || {};
                const codes = Object.keys(boards);

                // 若后端暂时只有一个 guess_game，这里也能正常工作
                if (codes.length === 0) {
                    const empty = document.createElement('section');
                    empty.className = 'card';
                    empty.innerHTML = `<h2>暂无排行榜</h2><p class="sub">没有可展示的数据。</p>`;
                    wrap.appendChild(empty);
                    return;
                }

                for (const code of codes) {
                    const items = boards[code] || [];
                    const card = renderCard(code, items, me.id);
                    wrap.appendChild(card);
                }
            }

            // 交互
            bind('btnRefresh', loadBoards);
            bind('backHome', () => location.href = '/page/shell');
            bind('logout', async () => {
                try { await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' }); }
                catch (e) { console.warn('调用登出接口异常：', e); }
                finally { localStorage.removeItem('token'); location.href = '/auth/login'; }
            });

            // 首屏
            loadBoards();
        })();
    </script>
</body>

</html>