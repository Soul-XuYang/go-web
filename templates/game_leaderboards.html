<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>æ¸¸æˆæ’è¡Œæ¦œ</title>
    <link rel="stylesheet" href="/static/base.css" />
    <style>
        body {
            margin: 0;
            padding: 0 !important;
            display: block !important;
            place-items: initial !important;
            background: var(--bg);
        }

        /* è¦†ç›– base.css çš„æŒ‰é’®æ ·å¼ */
        button {
            width: auto !important;
            font-size: 0.9rem;
            padding: 8px 16px;
            height: 36px;
            border-radius: 8px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 16px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--text);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .username {
            color: var(--muted);
            font-size: 0.9rem;
        }

        .leaderboard-container {
            display: flex;
            gap: 16px;
            justify-content: center;
            align-items: flex-start;
            margin: 20px 0 30px 0;
            flex-wrap: wrap;
        }

        .leaderboard-card {
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            flex: 1 1 320px;
            max-width: 380px;
        }

        @media (max-width: 1100px) {
            .leaderboard-card {
                flex: 1 1 280px;
                max-width: 450px;
            }
        }

        @media (max-width: 768px) {
            .leaderboard-card {
                flex: 1 1 100%;
                max-width: 100%;
            }
        }

        .card-title {
            margin: 0 0 8px 0;
            font-size: 1.1rem;
            color: var(--text);
            text-align: center;
        }

        .card-subtitle {
            margin: 0 0 16px 0;
            color: var(--muted);
            font-size: 0.85rem;
            text-align: center;
            line-height: 1.4;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-table th,
        .leaderboard-table td {
            padding: 10px 4px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .leaderboard-table th:first-child,
        .leaderboard-table td:first-child {
            padding-left: 0;
        }

        .leaderboard-table th:last-child,
        .leaderboard-table td:last-child {
            padding-right: 0;
        }

        .leaderboard-table th {
            color: var(--muted);
            font-weight: 600;
            font-size: 0.85rem;
        }

        .leaderboard-table td {
            color: var(--text);
            font-size: 0.9rem;
        }

        .rank-badge {
            display: inline-block;
            min-width: 28px;
            text-align: center;
            padding: 3px 6px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 0.75rem;
        }

        .rank-1 {
            background: #f59e0b;
            color: #1f2937;
        }

        .rank-2 {
            background: #9ca3af;
            color: #111827;
        }

        .rank-3 {
            background: #d97706;
            color: #111827;
        }

        .rank-other {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
        }

        .score {
            text-align: right;
            font-weight: 600;
        }

        /* ä¸ªäººæˆç»©å¡ç‰‡ */
        .my-stats-container {
            max-width: 1200px;
            margin: 0 auto 24px;
            padding: 0;
        }

        .my-stats-card {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(16, 185, 129, 0.08) 100%);
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: 10px;
            padding: 16px 20px;
            box-shadow: 0 2px 12px rgba(59, 130, 246, 0.1);
        }

        .my-stats-title {
            margin: 0 0 12px 0;
            font-size: 1rem;
            color: var(--text);
            text-align: center;
            font-weight: 600;
        }

        .stats-grid {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.6);
            border-radius: 8px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            min-width: 240px;
            flex: 0 1 auto;
        }

        .stat-game {
            font-weight: 600;
            color: var(--text);
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .stat-data {
            text-align: right;
            flex: 1;
        }

        .stat-score {
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 2px;
        }

        .stat-rank {
            font-size: 0.8rem;
            color: var(--muted);
        }

        .stat-rank.not-ranked {
            color: #f59e0b;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .stats-grid {
                flex-direction: column;
            }

            .stat-item {
                width: 100%;
            }
        }

        .footer {
            display: flex;
            justify-content: center;
            gap: 24px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- é¡¶éƒ¨æ ‡é¢˜å’Œç”¨æˆ·ä¿¡æ¯ -->
        <header class="header">
            <h1>æ¸¸æˆæ’è¡Œæ¦œ</h1>
            <div class="user-info">
                <div class="avatar" id="avatar">U</div>
                <span class="username" id="username">åŠ è½½ä¸­â€¦</span>
            </div>
        </header>

        <!-- ä¸ªäººæˆç»©ç»Ÿè®¡å¡ç‰‡ -->
        <div class="my-stats-container">
            <div class="my-stats-card">
                <h3 class="my-stats-title">ğŸ† æˆ‘çš„æ¸¸æˆæˆç»©</h3>
                <div class="stats-grid" id="myStatsWrap">
                    <!-- JS åŠ¨æ€æ’å…¥ä¸ªäººæˆç»© -->
                </div>
            </div>
        </div>

        <!-- æ’è¡Œæ¦œå¡ç‰‡å®¹å™¨ -->
        <div class="leaderboard-container" id="boardWrap">
            <!-- JS åŠ¨æ€æ’å…¥æ’è¡Œæ¦œå¡ç‰‡ -->
        </div>

        <!-- åº•éƒ¨æŒ‰é’® -->
        <div class="footer">
            <button id="btnRefresh" class="btn-primary">åˆ·æ–°æ’è¡Œæ¦œ</button>
            <button id="backHome" class="btn-primary">è¿”å›ä¸»èœå•</button>
            <button id="logout" class="btn-primary">é€€å‡ºç™»å½•</button>
        </div>
    </div>

    <script>
        (function () {
            const $ = s => document.querySelector(s);
            const wrap = $('#boardWrap');
            const myStatsWrap = $('#myStatsWrap');

            // å’Œåç«¯çš„ gameCode æ˜ å°„åˆ°å±•ç¤ºæ ‡é¢˜
            const GAME_TITLES = {
                'guess_game': 'æ•°å­—çŒœçŒœä¹',
                'map_game': 'åœ°å›¾å¯»è·¯æŒ‘æˆ˜',
                '2048_game': '2048æ¸¸æˆ',
                // ä»¥ååŠ æ›´å¤šï¼š'snake': 'è´ªåƒè›‡', ...
            };

            // æ¸¸æˆå›¾æ ‡
            const GAME_ICONS = {
                'guess_game': 'ğŸ¯',
                'map_game': 'ğŸ—ºï¸',
                '2048_game': 'ğŸ®',
            };

            function bind(id, handler) {
                const el = document.getElementById(id);
                if (el) el.addEventListener('click', handler);
            }

            function getStoredToken() {
                const t = localStorage.getItem('token');
                if (!t) return null;
                return t.toLowerCase().startsWith('bearer ') ? t : ('Bearer ' + t);
            }

            async function authFetch(url, opts = {}) {
                const token = getStoredToken();
                const headers = Object.assign(
                    { 'Content-Type': 'application/json' },
                    token ? { 'Authorization': token } : {},
                    opts.headers || {}
                );
                const r = await fetch(url, { credentials: 'include', ...opts, headers });
                if (r.status === 401) {
                    localStorage.removeItem('token');
                    location.href = '/auth/login';
                    throw new Error('Unauthorized');
                }
                return r;
            }

            function initialOf(name) {
                if (!name) return 'U';
                const s = String(name).trim();
                return s ? s[0].toUpperCase() : 'U';
            }

            async function loadMe() {
                try {
                    const r = await authFetch('/api/me');
                    const d = await r.json().catch(() => ({}));
                    const uname = d.username || d.name || 'unknown';
                    $('#username').textContent = uname;
                    $('#avatar').textContent = initialOf(uname);
                    return { id: d.user_id || d.id || 0, name: uname };
                } catch (e) {
                    console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥ï¼š', e);
                    return { id: 0, name: '' };
                }
            }

            function titleByCode(code) {
                return GAME_TITLES[code] || code;
            }

            function renderCard(gameCode, items, currentUID) {
                const card = document.createElement('div');
                card.className = 'leaderboard-card';

                const title = document.createElement('h2');
                title.className = 'card-title';
                title.textContent = titleByCode(gameCode);

                const subtitle = document.createElement('p');
                subtitle.className = 'card-subtitle';
                if (gameCode === 'map_game') {
                    subtitle.textContent = 'Top 10 æœ€å¿«å®Œæˆè®°å½•';
                } else if (gameCode === '2048_game') {
                    subtitle.textContent = 'Top 10 æœ€é«˜åˆ†æ•°';
                } else {
                    subtitle.textContent = 'Top 10 æœ€ä½³æˆç»©';
                }

                card.appendChild(title);
                card.appendChild(subtitle);

                if (!items || items.length === 0) {
                    const empty = document.createElement('div');
                    empty.style.textAlign = 'center';
                    empty.style.padding = '20px';
                    empty.style.color = 'var(--muted)';
                    empty.textContent = 'æš‚æ— ä¸Šæ¦œæ•°æ®';
                    card.appendChild(empty);
                    return card;
                }

                const table = document.createElement('table');
                table.className = 'leaderboard-table';

                const thead = document.createElement('thead');
                let scoreLabel = 'åˆ†æ•°';
                if (gameCode === 'map_game') {
                    scoreLabel = 'ç”¨æ—¶';
                } else if (gameCode === '2048_game') {
                    scoreLabel = 'åˆ†æ•°';
                }
                thead.innerHTML = `
      <tr>
        <th style="width:60px;">åæ¬¡</th>
        <th>ç”¨æˆ·</th>
        <th class="score">${scoreLabel}</th>
      </tr>`;
                table.appendChild(thead);

                const tbody = document.createElement('tbody');

                for (const row of items) {
                    const tr = document.createElement('tr');
                    if (currentUID && row.user_id === currentUID) tr.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';

                    const tdRank = document.createElement('td');
                    const badge = document.createElement('span');
                    badge.className = 'rank-badge';
                    badge.textContent = '#' + row.rank;
                    if (row.rank === 1) badge.classList.add('rank-1');
                    else if (row.rank === 2) badge.classList.add('rank-2');
                    else if (row.rank === 3) badge.classList.add('rank-3');
                    else badge.classList.add('rank-other');
                    tdRank.appendChild(badge);

                    const tdUser = document.createElement('td');
                    tdUser.textContent = row.username || String(row.user_id);

                    const tdScore = document.createElement('td');
                    tdScore.className = 'score';
                    // åœ°å›¾æ¸¸æˆæ˜¾ç¤ºæ—¶é—´æ ¼å¼ï¼Œå…¶ä»–æ¸¸æˆæ˜¾ç¤ºåˆ†æ•°
                    if (gameCode === 'map_game') {
                        const seconds = parseFloat(row.score);
                        tdScore.textContent = isNaN(seconds) ? row.score : seconds.toFixed(2) + 's';
                    } else if (gameCode === '2048_game') {
                        tdScore.textContent = parseInt(row.score).toLocaleString();
                    } else {
                        tdScore.textContent = row.score;
                    }

                    tr.appendChild(tdRank);
                    tr.appendChild(tdUser);
                    tr.appendChild(tdScore);
                    tbody.appendChild(tr);
                }

                table.appendChild(tbody);
                card.appendChild(table);
                return card;
            }

            // æ¸²æŸ“ä¸ªäººæˆç»©å¡ç‰‡
            function renderMyStats(gamesData, username) {
                myStatsWrap.innerHTML = '';

                if (!gamesData || Object.keys(gamesData).length === 0) {
                    myStatsWrap.innerHTML = '<div style="text-align:center;color:var(--muted)">æš‚æ— ä¸ªäººæˆç»©</div>';
                    return;
                }

                // æŒ‰å›ºå®šé¡ºåºæ¸²æŸ“ï¼šguess_game, map_game, 2048_game
                const order = ['guess_game', 'map_game', '2048_game'];

                for (const code of order) {
                    if (!gamesData[code]) continue;

                    const myRank = gamesData[code].my_rank;
                    const statItem = document.createElement('div');
                    statItem.className = 'stat-item';

                    const gameInfo = document.createElement('div');
                    const gameName = document.createElement('div');
                    gameName.className = 'stat-game';
                    gameName.textContent = `${GAME_ICONS[code] || 'ğŸ®'} ${GAME_TITLES[code] || code}`;
                    gameInfo.appendChild(gameName);

                    const statData = document.createElement('div');
                    statData.className = 'stat-data';

                    // åˆ†æ•°æ˜¾ç¤º
                    const scoreDiv = document.createElement('div');
                    scoreDiv.className = 'stat-score';
                    if (code === 'map_game') {
                        const seconds = parseFloat(myRank.best);
                        scoreDiv.textContent = isNaN(seconds) ? myRank.best : seconds.toFixed(2) + 's';
                    } else if (code === '2048_game') {
                        scoreDiv.textContent = parseInt(myRank.best).toLocaleString() + ' åˆ†';
                    } else {
                        scoreDiv.textContent = myRank.best + ' åˆ†';
                    }

                    // æ’åæ˜¾ç¤º
                    const rankDiv = document.createElement('div');
                    rankDiv.className = 'stat-rank';
                    if (myRank.rank === 0) {
                        rankDiv.classList.add('not-ranked');
                        rankDiv.textContent = 'æœªä¸Šæ¦œ';
                    } else {
                        rankDiv.textContent = `æ’å #${myRank.rank}`;
                    }

                    statData.appendChild(scoreDiv);
                    statData.appendChild(rankDiv);

                    statItem.appendChild(gameInfo);
                    statItem.appendChild(statData);
                    myStatsWrap.appendChild(statItem);
                }
            }

            async function loadBoards() {
                wrap.innerHTML = ''; // æ¸…ç©ºæ’è¡Œæ¦œ
                myStatsWrap.innerHTML = '<div style="text-align:center;color:var(--muted)">åŠ è½½ä¸­â€¦</div>';

                const me = await loadMe();

                let data;
                try {
                    // è°ƒç”¨æ–°çš„APIï¼ŒåŒæ—¶è·å–æ’è¡Œæ¦œå’Œä¸ªäººæ•°æ®
                    const r = await authFetch('/api/game/leaderboard/me');
                    data = await r.json();
                } catch (e) {
                    console.error('è¯»å–æ’è¡Œæ¦œå¤±è´¥ï¼š', e);
                    const errCard = document.createElement('section');
                    errCard.className = 'card';
                    errCard.innerHTML = `<h2>è¯»å–å¤±è´¥</h2><p class="sub">è¯·ç¨åå†è¯•ã€‚</p>`;
                    wrap.appendChild(errCard);
                    myStatsWrap.innerHTML = '<div style="text-align:center;color:var(--muted)">åŠ è½½å¤±è´¥</div>';
                    return;
                }

                const games = (data && data.games) || {};
                const codes = Object.keys(games);

                if (codes.length === 0) {
                    const empty = document.createElement('section');
                    empty.className = 'card';
                    empty.innerHTML = `<h2>æš‚æ— æ’è¡Œæ¦œ</h2><p class="sub">æ²¡æœ‰å¯å±•ç¤ºçš„æ•°æ®ã€‚</p>`;
                    wrap.appendChild(empty);
                    myStatsWrap.innerHTML = '<div style="text-align:center;color:var(--muted)">æš‚æ— æ•°æ®</div>';
                    return;
                }

                // æ¸²æŸ“æ’è¡Œæ¦œå¡ç‰‡
                for (const code of codes) {
                    const gameData = games[code];
                    const items = gameData.leaderboard || [];
                    const card = renderCard(code, items, me.id);
                    wrap.appendChild(card);
                }

                // æ¸²æŸ“ä¸ªäººæˆç»©
                renderMyStats(games, data.username);
            }

            // äº¤äº’
            bind('btnRefresh', loadBoards);
            bind('backHome', () => location.href = '/page/shell');
            bind('logout', async () => {
                try { await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' }); }
                catch (e) { console.warn('è°ƒç”¨ç™»å‡ºæ¥å£å¼‚å¸¸ï¼š', e); }
                finally { localStorage.removeItem('token'); location.href = '/auth/login'; }
            });

            // é¦–å±
            loadBoards();
        })();
    </script>
</body>

</html>