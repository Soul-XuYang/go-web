<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>游戏排行榜</title>
    <link rel="stylesheet" href="/static/base.css" />
    <style>
        body {
            margin: 0;
            padding: 0 !important;
            display: block !important;
            place-items: initial !important;
            background: var(--bg);
        }

        /* 覆盖 base.css 的按钮样式 */
        button {
            width: auto !important;
            font-size: 0.9rem;
            padding: 8px 16px;
            height: 36px;
            border-radius: 8px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px 16px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--text);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .username {
            color: var(--muted);
            font-size: 0.9rem;
        }

        .toolbar {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .leaderboard-container {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }

        .leaderboard-card {
            background: var(--card);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 100%;
        }

        .card-title {
            margin: 0 0 8px 0;
            font-size: 1.2rem;
            color: var(--text);
        }

        .card-subtitle {
            margin: 0 0 20px 0;
            color: var(--muted);
            font-size: 0.9rem;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-table th,
        .leaderboard-table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .leaderboard-table th {
            color: var(--muted);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .leaderboard-table td {
            color: var(--text);
        }

        .rank-badge {
            display: inline-block;
            min-width: 32px;
            text-align: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .rank-1 {
            background: #f59e0b;
            color: #1f2937;
        }

        .rank-2 {
            background: #9ca3af;
            color: #111827;
        }

        .rank-3 {
            background: #d97706;
            color: #111827;
        }

        .rank-other {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
        }

        .score {
            text-align: right;
            font-weight: 600;
        }

        .footer {
            display: flex;
            justify-content: center;
            gap: 24px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- 顶部标题和用户信息 -->
        <header class="header">
            <h1>游戏排行榜</h1>
            <div class="user-info">
                <div class="avatar" id="avatar">U</div>
                <span class="username" id="username">加载中…</span>
            </div>
        </header>

        <!-- 工具栏 -->
        <div class="toolbar">
            <button id="btnRefresh" class="btn-primary">刷新排行榜</button>
        </div>

        <!-- 排行榜卡片 -->
        <div class="leaderboard-container">
            <div class="leaderboard-card" id="boardWrap">
                <!-- JS 动态插入排行榜内容 -->
            </div>
        </div>

        <!-- 底部按钮 -->
        <div class="footer">
            <button id="backHome" class="btn-primary">返回主菜单</button>
            <button id="logout" class="btn-primary">退出登录</button>
        </div>
    </div>

    <script>
        (function () {
            const $ = s => document.querySelector(s);
            const wrap = $('#boardWrap');

            // 和后端的 gameCode 映射到展示标题
            const GAME_TITLES = {
                'guess_game': '数字猜猜乐 · Top 10',
                'map_game': '地图寻路挑战 · Top 10',
                // 以后加更多：'snake': '贪吃蛇 · Top 10', ...
            };

            function bind(id, handler) {
                const el = document.getElementById(id);
                if (el) el.addEventListener('click', handler);
            }

            function getStoredToken() {
                const t = localStorage.getItem('token');
                if (!t) return null;
                return t.toLowerCase().startsWith('bearer ') ? t : ('Bearer ' + t);
            }

            async function authFetch(url, opts = {}) {
                const token = getStoredToken();
                const headers = Object.assign(
                    { 'Content-Type': 'application/json' },
                    token ? { 'Authorization': token } : {},
                    opts.headers || {}
                );
                const r = await fetch(url, { credentials: 'include', ...opts, headers });
                if (r.status === 401) {
                    localStorage.removeItem('token');
                    location.href = '/auth/login';
                    throw new Error('Unauthorized');
                }
                return r;
            }

            function initialOf(name) {
                if (!name) return 'U';
                const s = String(name).trim();
                return s ? s[0].toUpperCase() : 'U';
            }

            async function loadMe() {
                try {
                    const r = await authFetch('/api/me');
                    const d = await r.json().catch(() => ({}));
                    const uname = d.username || d.name || 'unknown';
                    $('#username').textContent = uname;
                    $('#avatar').textContent = initialOf(uname);
                    return { id: d.user_id || d.id || 0, name: uname };
                } catch (e) {
                    console.error('加载用户信息失败：', e);
                    return { id: 0, name: '' };
                }
            }

            function titleByCode(code) {
                return GAME_TITLES[code] || (code + ' · Top 10');
            }

            function renderCard(gameCode, items, currentUID) {
                const card = document.createElement('div');
                card.className = 'leaderboard-card';

                const title = document.createElement('h2');
                title.className = 'card-title';
                title.textContent = titleByCode(gameCode);

                const subtitle = document.createElement('p');
                subtitle.className = 'card-subtitle';
                if (gameCode === 'map_game') {
                    subtitle.textContent = '展示前 10 名最快完成记录（用时越短排名越高）。';
                } else {
                    subtitle.textContent = '展示 Redis ZSET 的前 10 名（按分数降序）。';
                }

                card.appendChild(title);
                card.appendChild(subtitle);

                if (!items || items.length === 0) {
                    const empty = document.createElement('div');
                    empty.style.textAlign = 'center';
                    empty.style.padding = '20px';
                    empty.style.color = 'var(--muted)';
                    empty.textContent = '暂无上榜数据';
                    card.appendChild(empty);
                    return card;
                }

                const table = document.createElement('table');
                table.className = 'leaderboard-table';

                const thead = document.createElement('thead');
                const scoreLabel = gameCode === 'map_game' ? '用时(秒)' : '分数';
                thead.innerHTML = `
      <tr>
        <th style="width:80px;">名次</th>
        <th>用户</th>
        <th class="score">${scoreLabel}</th>
      </tr>`;
                table.appendChild(thead);

                const tbody = document.createElement('tbody');

                for (const row of items) {
                    const tr = document.createElement('tr');
                    if (currentUID && row.user_id === currentUID) tr.style.backgroundColor = 'rgba(59, 130, 246, 0.1)';

                    const tdRank = document.createElement('td');
                    const badge = document.createElement('span');
                    badge.className = 'rank-badge';
                    badge.textContent = '#' + row.rank;
                    if (row.rank === 1) badge.classList.add('rank-1');
                    else if (row.rank === 2) badge.classList.add('rank-2');
                    else if (row.rank === 3) badge.classList.add('rank-3');
                    else badge.classList.add('rank-other');
                    tdRank.appendChild(badge);

                    const tdUser = document.createElement('td');
                    tdUser.textContent = row.username || String(row.user_id);

                    const tdScore = document.createElement('td');
                    tdScore.className = 'score';
                    // 地图游戏显示时间格式，其他游戏显示分数
                    if (gameCode === 'map_game') {
                        const seconds = parseFloat(row.score);
                        tdScore.textContent = isNaN(seconds) ? row.score : seconds.toFixed(2) + 's';
                    } else {
                        tdScore.textContent = row.score;
                    }

                    tr.appendChild(tdRank);
                    tr.appendChild(tdUser);
                    tr.appendChild(tdScore);
                    tbody.appendChild(tr);
                }

                table.appendChild(tbody);
                card.appendChild(table);
                return card;
            }

            async function loadBoards() {
                wrap.innerHTML = ''; // 清空
                const me = await loadMe();

                let data;
                try {
                    const r = await authFetch('/api/game/leaderboards');
                    data = await r.json();
                } catch (e) {
                    console.error('读取排行榜失败：', e);
                    const errCard = document.createElement('section');
                    errCard.className = 'card';
                    errCard.innerHTML = `<h2>读取失败</h2><p class="sub">请稍后再试。</p>`;
                    wrap.appendChild(errCard);
                    return;
                }

                const boards = (data && data.leaderboards) || {};
                const codes = Object.keys(boards);

                // 若后端暂时只有一个 guess_game，这里也能正常工作
                if (codes.length === 0) {
                    const empty = document.createElement('section');
                    empty.className = 'card';
                    empty.innerHTML = `<h2>暂无排行榜</h2><p class="sub">没有可展示的数据。</p>`;
                    wrap.appendChild(empty);
                    return;
                }

                for (const code of codes) {
                    const items = boards[code] || [];
                    const card = renderCard(code, items, me.id);
                    wrap.appendChild(card);
                }
            }

            // 交互
            bind('btnRefresh', loadBoards);
            bind('backHome', () => location.href = '/page/shell');
            bind('logout', async () => {
                try { await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' }); }
                catch (e) { console.warn('调用登出接口异常：', e); }
                finally { localStorage.removeItem('token'); location.href = '/auth/login'; }
            });

            // 首屏
            loadBoards();
        })();
    </script>
</body>

</html>