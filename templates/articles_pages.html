<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文章列表 - 论坛系统</title>
    <link rel="stylesheet" href="/static/article_list.css">
</head>

<body>
    <!-- 顶部导航栏 -->
    <header class="zhihu-header">
        <div class="zhihu-header-inner">
            <a href="/page/shell" class="zhihu-logo">
                <div class="zhihu-logo-icon">论</div>
                <span>Go-Web论坛社区</span>
            </a>
            <div class="zhihu-user-chip">
                <div class="zhihu-user-avatar" id="avatar">U</div>
                <span class="zhihu-user-name" id="username">加载中...</span>
            </div>
        </div>
    </header>

    <!-- 主内容区域 -->
    <main class="zhihu-main">
        <!-- 搜索和排序区域 -->
        <div class="zhihu-search-bar">
            <div class="zhihu-search-input-wrap">
                <input type="text" class="zhihu-search-input" id="searchInput" placeholder="搜索感兴趣的内容..." />
                <button class="zhihu-search-btn" id="btnSearch">搜索</button>
            </div>

            <!-- 排序标签 -->
            <div class="zhihu-sort-tabs">
                <button class="zhihu-sort-tab active" data-sort="created_desc">最新</button>
                <button class="zhihu-sort-tab" data-sort="likes_desc">最热</button>
                <button class="zhihu-sort-tab" data-sort="comments_desc">最多评论</button>
                <button class="zhihu-sort-tab" data-sort="reposts_desc">最多转发</button>
            </div>
        </div>

        <!-- 操作按钮组 -->
        <div class="zhihu-action-bar">
            <button class="zhihu-btn" id="btnBack">返回主菜单</button>
            <button class="zhihu-btn zhihu-btn-primary" id="btnCreate">写文章</button>
            <button class="zhihu-btn" id="btnMyArticles">我的文章</button>
            <button class="zhihu-btn" id="btnRefresh">刷新</button>
        </div>

        <!-- 文章列表容器 -->
        <div class="zhihu-article-container">
            <div id="articleList">
                <div class="zhihu-loading">加载中...</div>
            </div>
        </div>

        <!-- 分页 -->
        <div class="zhihu-pagination">
            <button class="zhihu-page-btn" id="btnPrev" disabled>上一页</button>
            <span class="zhihu-page-info">第 <span id="pageNum">1</span> 页</span>
            <button class="zhihu-page-btn" id="btnNext">下一页</button>
        </div>
    </main>

    <script>
        // ========== 工具函数 ==========
        const $ = s => document.querySelector(s);
        const $$ = s => Array.from(document.querySelectorAll(s));

        // 获取 Token
        function getStoredToken() {
            const t = localStorage.getItem('token');
            return t ? (t.toLowerCase().startsWith('bearer ') ? t : 'Bearer ' + t) : null;
        }

        // 带认证的 fetch
        async function authFetch(url, opts = {}) {
            const token = getStoredToken();
            const headers = Object.assign(
                { 'Content-Type': 'application/json' },
                token ? { 'Authorization': token } : {},
                opts.headers || {}
            );
            const r = await fetch(url, { ...opts, headers });
            if (r.status === 401) {
                localStorage.removeItem('token');
                location.href = '/auth/login';
                throw new Error('Unauthorized');
            }
            return r;
        }

        // HTML 转义
        function escapeHTML(s) {
            const div = document.createElement('div');
            div.textContent = s ?? '';
            return div.innerHTML;
        }

        // ========== 状态管理 ==========
        let currentPage = 1;
        let currentSort = 'created_desc';
        let currentSearch = '';

        // ========== 加载用户信息 ==========
        async function loadUser() {
            try {
                const r = await authFetch('/api/me', { cache: 'no-store' });
                const data = await r.json().catch(() => ({}));
                const username = data.username || 'unknown';
                $('#username').textContent = username;
                $('#avatar').textContent = (username?.trim?.()[0] || 'U').toUpperCase();
            } catch (e) {
                console.error('加载用户信息失败:', e);
            }
        }

        // ========== 渲染文章列表 ==========
        function renderArticles(articles) {
            const container = $('#articleList');

            if (!Array.isArray(articles) || articles.length === 0) {
                container.innerHTML = '<div class="zhihu-empty">暂无文章</div>';
                return;
            }

            container.innerHTML = '';

            articles.forEach(article => {
                const card = document.createElement('div');
                card.className = 'zhihu-article-card';
                card.onclick = () => location.href = '/page/articles/' + article.id;

                // 用户头像
                const avatar = (article.username || 'U')[0].toUpperCase();

                // 格式化数字显示
                const formatNumber = (count) => {
                    if (!count || count === 0) return '0';
                    if (count >= 10000) return `${(count / 10000).toFixed(1)}万`;
                    return `${count}`;
                };

                const likesText = `点赞 ${formatNumber(article.likes)}`;
                const commentsText = `评论 ${formatNumber(article.commentcount)}`;
                const collectionsText = `收藏 ${formatNumber(article.collection_count)}`;

                card.innerHTML = `
                    <div class="zhihu-card-user">
                        <div class="zhihu-card-avatar">${avatar}</div>
                        <span class="zhihu-card-username">${escapeHTML(article.username || '匿名用户')}</span>
                    </div>
                    <h2 class="zhihu-card-title">${escapeHTML(article.title)}</h2>
                    <p class="zhihu-card-preview">${escapeHTML(article.preview || '')}</p>
                    <div class="zhihu-card-actions">
                        <div class="zhihu-card-action" onclick="event.stopPropagation()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path>
                            </svg>
                            <span class="zhihu-card-action-text">${likesText}</span>
                        </div>
                        <div class="zhihu-card-action" onclick="event.stopPropagation()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                            <span class="zhihu-card-action-text">${commentsText}</span>
                        </div>
                        <div class="zhihu-card-action" onclick="event.stopPropagation()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M6 4h12a1 1 0 0 1 1 1v14l-7-4-7 4V5a1 1 0 0 1 1-1z"></path>
                            </svg>
                            <span class="zhihu-card-action-text">${collectionsText}</span>
                        </div>
                        <div class="zhihu-card-action" onclick="event.stopPropagation()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <circle cx="18" cy="5" r="3"></circle>
                                <circle cx="6" cy="12" r="3"></circle>
                                <circle cx="18" cy="19" r="3"></circle>
                                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                            </svg>
                            <span class="zhihu-card-action-text">转发</span>
                        </div>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // ========== 加载文章列表 ==========
        async function loadArticles() {
            const container = $('#articleList');
            container.innerHTML = '<div class="zhihu-loading">加载中...</div>';

            try {
                // 构建查询参数
                const params = new URLSearchParams({
                    page: currentPage,
                    page_size: 20,
                    order: currentSort
                });

                if (currentSearch.trim()) {
                    params.set('title', currentSearch.trim());
                }

                const url = '/api/articles?' + params.toString();
                const r = await authFetch(url, { cache: 'no-store' });
                const articles = await r.json();

                renderArticles(articles);
                updatePagination(articles.length);

            } catch (e) {
                console.error('加载文章失败:', e);
                container.innerHTML = `<div class="zhihu-error">加载失败：${e.message || '未知错误'}</div>`;
            }
        }

        // ========== 更新分页按钮 ==========
        function updatePagination(articleCount) {
            $('#pageNum').textContent = currentPage;
            $('#btnPrev').disabled = currentPage === 1;
            $('#btnNext').disabled = articleCount < 20;
        }

        // ========== 排序切换 ==========
        function setupSortTabs() {
            $$('.zhihu-sort-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    // 移除所有激活状态
                    $$('.zhihu-sort-tab').forEach(t => t.classList.remove('active'));
                    // 激活当前标签
                    tab.classList.add('active');
                    // 更新排序并重新加载
                    currentSort = tab.dataset.sort;
                    currentPage = 1;
                    loadArticles();
                });
            });
        }

        // ========== 事件绑定 ==========
        function setupEventListeners() {
            // 返回按钮
            $('#btnBack').onclick = () => location.href = '/page/shell';

            // 写文章
            $('#btnCreate').onclick = () => location.href = '/page/articles/create';

            // 我的文章
            $('#btnMyArticles').onclick = () => location.href = '/page/articles/my/list';

            // 刷新
            $('#btnRefresh').onclick = () => {
                currentPage = 1;
                loadArticles();
            };

            // 搜索
            $('#btnSearch').onclick = () => {
                currentSearch = $('#searchInput').value;
                currentPage = 1;
                loadArticles();
            };

            // 回车搜索
            $('#searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    $('#btnSearch').click();
                }
            });

            // 分页
            $('#btnPrev').onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadArticles();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };

            $('#btnNext').onclick = () => {
                currentPage++;
                loadArticles();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };
        }

        // ========== 初始化 ==========
        document.addEventListener('DOMContentLoaded', () => {
            loadUser();
            setupSortTabs();
            setupEventListeners();
            loadArticles();
        });
    </script>
</body>

</html>