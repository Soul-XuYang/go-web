<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>汇率管理</title>
    <link rel="stylesheet" href="/static/base.css" />
    <style>
        html {
            font-size: 18px;
        }

        body {
            padding: 4vh 16px;
        }

        .card {
            margin: 0 auto;
            padding: 36px;
        }

        .card.wide {
            max-width: 1080px;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 22px;
        }

        .user {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            padding: 10px 14px;
            border-radius: 999px;
            background: rgba(255, 255, 255, .06);
            border: 1px solid rgba(255, 255, 255, .08);
        }

        .user .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--ok);
            display: inline-block;
        }

        .actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 14px;
        }

        @media (max-width:960px) {
            .grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .input {
            padding: 14px 16px;
        }

        .input input {
            font-size: 1.05rem;
        }

        .msg {
            margin-top: 10px;
            min-height: 1.2em;
        }

        .table-wrap {
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 12px;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 1.05rem;
        }

        thead th {
            position: sticky;
            top: 0;
            background: rgba(0, 0, 0, .15);
            backdrop-filter: blur(4px);
            color: var(--muted);
            font-weight: 800;
            text-align: left;
            padding: 14px 16px;
        }

        tbody td {
            padding: 14px 16px;
            border-top: 1px solid rgba(255, 255, 255, .06);
        }

        tbody tr:nth-child(odd) {
            background: rgba(255, 255, 255, .02);
        }

        tbody tr:hover {
            background: rgba(255, 255, 255, .05);
        }

        tbody tr.editing {
            box-shadow: inset 0 0 0 2px rgba(77, 163, 255, .45);
            background: rgba(77, 163, 255, .12);
        }

        .pill {
            padding: 10px 16px;
            border-radius: 999px;
            background: rgba(255, 255, 255, .06);
            border: 1px solid rgba(255, 255, 255, .1);
            font-weight: 700;
            cursor: pointer;
        }

        .actions-cell {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .action-btn {
            border-radius: 999px;
            padding: 6px 14px;
            font-size: .88rem;
            border: 1px solid rgba(255, 255, 255, .12);
            background: rgba(255, 255, 255, .08);
            color: #e8eefc;
            cursor: pointer;
            transition: background .18s ease, transform .15s ease;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, .18);
            transform: translateY(-1px);
        }

        .action-btn.delete {
            border-color: rgba(220, 38, 38, .35);
            background: rgba(220, 38, 38, .12);
            color: #ff9b9b;
        }

        .action-btn.delete:hover {
            background: rgba(220, 38, 38, .22);
        }

        #cancelEdit {
            display: none;
            background: rgba(255, 255, 255, .12);
            border: 1px solid rgba(255, 255, 255, .18);
            color: #e8eefc;
            padding: 0 16px;
            border-radius: 999px;
            height: 42px;
            cursor: pointer;
        }

        #cancelEdit:hover {
            background: rgba(255, 255, 255, .22);
        }

        .editing-hint {
            color: #4da3ff;
            font-weight: 600;
        }

        /* 底部按钮区域（两颗按钮并排居中，不会拉满左右） */
        .bottom-actions {
            margin-top: 24px;
            display: flex;
            justify-content: center;
            gap: 16px;
        }

        .bottom-actions button {
            padding: 10px 16px;
            border-radius: 999px;
            font-weight: 700;
            min-width: 160px;
            cursor: pointer;
        }

        .bottom-actions button:active {
            opacity: .9;
        }
    </style>
</head>

<body>
    <div class="card card-lg wide">
        <div class="toolbar">
            <div>
                <h1 style="margin:0">汇率管理</h1>
                <div class="sub">查看已有汇率、并新增一条记录</div>
            </div>
            <div class="actions">
                <div class="user"><span class="dot"></span><span id="username">加载中…</span></div>
                <button id="refresh" class="pill">刷新</button>
                <button id="logout" class="pill">退出登录</button>
            </div>
        </div>

        <!-- 新增表单 -->
        <form id="form">
            <div class="grid">
                <div>
                    <label>源货币（FromCurrency）</label>
                    <div class="input"><input id="from" placeholder="如：USD" maxlength="10" required /></div>
                </div>
                <div>
                    <label>目标货币（ToCurrency）</label>
                    <div class="input"><input id="to" placeholder="如：CNY" maxlength="10" required /></div>
                </div>
                <div>
                    <label>汇率（Rate）</label>
                    <div class="input"><input id="rate" type="number" step="0.00000001" placeholder="如：7.1234"
                            required /></div>
                </div>
                <div style="display:flex;align-items:flex-end;gap:10px;flex-wrap:wrap">
                    <button id="btn" type="submit">新增</button>
                    <button id="cancelEdit" type="button">取消编辑</button>
                </div>
            </div>
            <div id="msg" class="msg"></div>
        </form>

        <!-- 列表 -->
        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th style="width:80px">#</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Rate</th>
                        <th>Date</th>
                        <th style="width:180px">操作</th>
                    </tr>
                </thead>
                <tbody id="tbody">
                    <tr>
                        <td colspan="6" class="muted">加载中…</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 底部按钮：返回主菜单 + RMBTOP10 -->
        <div class="bottom-actions">
            <button id="backHome">返回主菜单</button>
            <button id="rmbRates">跳转到RMBTOP10汇率页</button>
        </div>
    </div>

    <script>
        const $ = s => document.querySelector(s);
        const tbody = $('#tbody'), msg = $('#msg'), btn = $('#btn'), usernameEl = $('#username'), cancelEditBtn = $('#cancelEdit');
        let editingId = null;
        let editingRow = null;

        const FIELD_KEYS = {
            id: ['_id', 'id', 'ID', 'Id', '_Id'],
            from: ['FromCurrency', 'from_currency', 'fromCurrency', 'from', 'FromCurreny', 'fromCurreny'],
            to: ['ToCurrency', 'to_currency', 'toCurrency', 'to', 'ToCurreny', 'toCurreny'],
            rate: ['Rate', 'rate'],
            date: ['Date', 'date']
        };

        function pickField(obj, keys, fallback = '') {
            for (const key of keys) {
                if (Object.prototype.hasOwnProperty.call(obj, key) && obj[key] != null) {
                    return obj[key];
                }
                if (obj[key] != null) {
                    return obj[key];
                }
            }
            return fallback;
        }

        function escapeHTML(value) {
            return String(value ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
        }

        function escapeAttr(value) {
            return escapeHTML(value)
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function buildAuthHeader() {
            const raw = localStorage.getItem('token');
            if (!raw) return {};
            const token = raw.toLowerCase().startsWith('bearer ') ? raw : ('Bearer ' + raw);
            return { Authorization: token };
        }
        async function authFetch(url, opts = {}) {
            const headers = Object.assign({ 'Content-Type': 'application/json' }, buildAuthHeader(), opts.headers || {});
            const res = await fetch(url, { ...opts, headers });
            if (res.status === 401) { localStorage.removeItem('token'); location.href = '/auth/login'; throw new Error('Unauthorized'); }
            return res;
        }

        async function loadMe() {
            try {
                const res = await authFetch('/api/me');
                const data = await res.json().catch(() => ({}));
                usernameEl.textContent = data.username || '未知用户';
            } catch { }
        }

        async function loadRates() {
            tbody.innerHTML = `<tr><td colspan="6" class="muted">加载中…</td></tr>`;
            try {
                const res = await authFetch('/api/exchangeRates');
                if (!res.ok) throw new Error('加载失败');
                const list = await res.json();
                if (!Array.isArray(list) || list.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" class="muted">暂无数据</td></tr>`;
                    return;
                }
                tbody.innerHTML = list.map((it, idx) => {
                    const idRaw = pickField(it, FIELD_KEYS.id, '');
                    const id = idRaw !== undefined && idRaw !== null ? String(idRaw) : '';
                    const fromRaw = pickField(it, FIELD_KEYS.from, '');
                    const toRaw = pickField(it, FIELD_KEYS.to, '');
                    const rateRaw = pickField(it, FIELD_KEYS.rate, '');
                    const dateRaw = pickField(it, FIELD_KEYS.date, '');
                    const dateStr = dateRaw ? new Date(dateRaw).toLocaleString() : '';
                    const actions = id
                        ? `<div class="actions-cell"><button class="action-btn edit" data-action="edit" data-id="${escapeAttr(id)}" data-from="${escapeAttr(fromRaw)}" data-to="${escapeAttr(toRaw)}" data-rate="${escapeAttr(rateRaw)}">编辑</button><button class="action-btn delete" data-action="delete" data-id="${escapeAttr(id)}" data-from="${escapeAttr(fromRaw)}" data-to="${escapeAttr(toRaw)}">删除</button></div>`
                        : '<span class="muted">-</span>';
                    return `<tr data-id="${escapeAttr(id)}"><td>${idx + 1}</td><td>${escapeHTML(fromRaw)}</td><td>${escapeHTML(toRaw)}</td><td>${escapeHTML(rateRaw)}</td><td>${escapeHTML(dateStr)}</td><td>${actions}</td></tr>`;
                }).join('');

                if (editingId) {
                    const row = tbody.querySelector(`tr[data-id="${editingId.replace(/"/g, '\\"')}"]`);
                    if (row) {
                        if (editingRow) editingRow.classList.remove('editing');
                        row.classList.add('editing');
                        editingRow = row;
                    } else if (editingRow) {
                        editingRow.classList.remove('editing');
                        editingRow = null;
                    }
                } else if (editingRow) {
                    editingRow.classList.remove('editing');
                    editingRow = null;
                }
            } catch (err) {
                console.error(err);
                tbody.innerHTML = `<tr><td colspan="6" class="badge-err">加载失败</td></tr>`;
            }
        }

        function resetForm(clearInputs = true) {
            if (clearInputs) {
                $('#from').value = '';
                $('#to').value = '';
                $('#rate').value = '';
            }
            editingId = null;
            if (editingRow) {
                editingRow.classList.remove('editing');
                editingRow = null;
            }
            btn.textContent = '新增';
            cancelEditBtn.style.display = 'none';
            cancelEditBtn.disabled = false;
        }

        function startEdit(data, row) {
            editingId = data.id;
            $('#from').value = String(data.from ?? '').toUpperCase();
            $('#to').value = String(data.to ?? '').toUpperCase();
            $('#rate').value = data.rate ?? '';
            btn.textContent = '保存修改';
            cancelEditBtn.style.display = 'inline-flex';
            cancelEditBtn.disabled = false;
            msg.className = 'msg editing-hint';
            msg.textContent = `正在编辑：${(data.from || '-').toUpperCase()} → ${(data.to || '-').toUpperCase()}（ID ${data.id}）`;
            if (editingRow && editingRow !== row) {
                editingRow.classList.remove('editing');
            }
            editingRow = row;
            if (editingRow) {
                editingRow.classList.add('editing');
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        $('#form').addEventListener('submit', async (e) => {
            e.preventDefault();
            msg.className = 'msg';
            msg.textContent = '';

            const from = $('#from').value.trim().toUpperCase();
            const to = $('#to').value.trim().toUpperCase();
            const rateValue = $('#rate').value;
            const isEditing = Boolean(editingId);

            if (!from || !to) {
                msg.classList.add('error');
                msg.textContent = '请输入 From/To';
                return;
            }
            if (!rateValue || Number(rateValue) <= 0) {
                msg.classList.add('error');
                msg.textContent = '汇率需为正数';
                return;
            }

            btn.disabled = true;
            cancelEditBtn.disabled = true;
            btn.textContent = isEditing ? '保存中…' : '提交中…';

            try {
                let res;
                if (isEditing) {
                    res = await authFetch(`/api/exchangeRates/${editingId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            from_currency: from,
                            to_currency: to,
                            rate: Number(rateValue)
                        })
                    });
                } else {
                    res = await authFetch('/api/exchangeRates', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            FromCurrency: from,
                            ToCurrency: to,
                            Rate: Number(rateValue)
                        })
                    });
                }

                const data = await res.json().catch(() => ({}));
                if (!res.ok) {
                    msg.classList.add('error');
                    msg.textContent = data.error || (isEditing ? '更新失败' : '新增失败');
                    return;
                }

                msg.classList.add('ok');
                msg.textContent = isEditing ? '更新成功' : '新增成功';
                resetForm();
                loadRates();
            } catch (err) {
                console.error(err);
                msg.classList.add('error');
                msg.textContent = '网络错误';
            } finally {
                btn.disabled = false;
                cancelEditBtn.disabled = false;
                btn.textContent = editingId ? '保存修改' : '新增';
                if (!editingId) {
                    cancelEditBtn.style.display = 'none';
                }
            }
        });

        cancelEditBtn.addEventListener('click', () => {
            resetForm();
            msg.className = 'msg';
            msg.textContent = '';
        });

        tbody.addEventListener('click', async (e) => {
            const actionBtn = e.target.closest('button[data-action]');
            if (!actionBtn) return;

            const id = actionBtn.dataset.id;
            if (!id) {
                alert('未找到该记录的 ID，无法执行操作。');
                return;
            }

            if (actionBtn.dataset.action === 'edit') {
                const row = actionBtn.closest('tr');
                startEdit({
                    id,
                    from: actionBtn.dataset.from || '',
                    to: actionBtn.dataset.to || '',
                    rate: actionBtn.dataset.rate || ''
                }, row);
            } else if (actionBtn.dataset.action === 'delete') {
                const label = `${(actionBtn.dataset.from || '?').toUpperCase()} → ${(actionBtn.dataset.to || '?').toUpperCase()}`;
                if (!confirm(`确定删除汇率 ${label} (ID ${id}) 吗？`)) {
                    return;
                }
                const prevText = actionBtn.textContent;
                actionBtn.disabled = true;
                actionBtn.textContent = '删除中…';
                try {
                    const res = await authFetch(`/api/exchangeRates/${id}`, { method: 'DELETE' });
                    const data = await res.json().catch(() => ({}));
                    if (!res.ok) {
                        alert('删除失败：' + (data.error || '未知错误'));
                        return;
                    }
                    if (editingId === id) {
                        resetForm();
                    }
                    msg.className = 'msg ok';
                    msg.textContent = '删除成功';
                    loadRates();
                } catch (err) {
                    console.error(err);
                    alert('删除失败：' + (err?.message || '网络错误'));
                } finally {
                    actionBtn.disabled = false;
                    actionBtn.textContent = prevText;
                }
            }
        });

        $('#refresh').onclick = () => loadRates();
        $('#logout').onclick = async () => {
            await fetch('/api/auth/logout', { method: 'POST' });
            localStorage.removeItem('token'); location.href = '/auth/login';
        };
        $('#backHome').onclick = () => { location.href = '/page/shell'; };
        $('#rmbRates').onclick = () => { location.href = '/page/rmb-top10'; };

        // 让底部两颗按钮的视觉风格与“新增”一致（不改大小，仅同步配色/圆角等）
        function alignButtonsWithPrimary() {
            const src = document.getElementById('btn'); if (!src) return;
            const targets = [document.getElementById('backHome'), document.getElementById('rmbRates')].filter(Boolean);
            const s = getComputedStyle(src);
            const props = ['background', 'backgroundColor', 'color', 'borderColor', 'borderStyle', 'borderWidth', 'borderRadius', 'fontWeight', 'fontSize', 'lineHeight', 'letterSpacing', 'boxShadow', 'textTransform', 'transition'];
            for (const el of targets) { for (const p of props) { el.style[p] = s[p]; } }
        }

        // init
        loadMe(); loadRates();
        if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', () => requestAnimationFrame(alignButtonsWithPrimary)); }
        else { requestAnimationFrame(alignButtonsWithPrimary); }
        window.addEventListener('load', alignButtonsWithPrimary);
    </script>
</body>

</html>