<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Dashborad-管理控制台</title>
    <link rel="stylesheet" href="/static/base.css" />
    <style>
        :root {
            --gap: 18px;
            --card-radius: 16px;
            --shadow-sm: 0 8px 30px rgba(15, 23, 42, 0.08);
            --text-muted: #6b7280;
            --bg: linear-gradient(135deg, #f5f7fb 0%, #eef3ff 100%);
            --gradient-blue: linear-gradient(135deg, #2563eb, #60a5fa);
            --gradient-indigo: linear-gradient(135deg, #6366f1, #8b5cf6);
            --gradient-purple: linear-gradient(135deg, #7c3aed, #a855f7);
            --gradient-pink: linear-gradient(135deg, #db2777, #f472b6);
            --gradient-orange: linear-gradient(135deg, #f97316, #facc15);
            --gradient-lime: linear-gradient(135deg, #22c55e, #a3e635);
            --gradient-cyan: linear-gradient(135deg, #0891b2, #22d3ee);
            --gradient-slate: linear-gradient(135deg, #475569, #94a3b8);
            --gradient-teal: linear-gradient(135deg, #14b8a6, #2dd4bf);
            --gradient-rose: linear-gradient(135deg, #f43f5e, #fb7185);
        }

        body {
            background: var(--bg);
            min-height: 100vh;
            font-family: "PingFang SC", "Helvetica Neue", Arial, sans-serif;
            color: #0f172a;
        }

        .wrap {
            max-width: 1360px;
            margin: 0 auto;
            padding: 32px 24px 48px;
        }

        .topbar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 10px;
        }

        .topbar h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .topbar h1 span {
            display: block;
            margin-top: 6px;
            font-size: 14px;
            font-weight: 400;
            color: var(--text-muted);
        }

        .surface {
            background: rgba(255, 255, 255, 0.86);
            backdrop-filter: blur(16px);
            border-radius: var(--card-radius);
            padding: 12px 16px;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .surface.search-card {
            justify-content: flex-start;
        }

        .surface.search-card .btn {
            padding: 8px 16px;
        }

        .surface input {
            border: none;
            outline: none;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 12px;
            padding: 8px 12px;
            font-size: 14px;
            color: #0f172a;
            box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.12);
            min-width: 140px;
        }

        .surface input {
            width: min(320px, 100%);
        }

        .grid {
            display: grid;
            gap: var(--gap);
            grid-template-columns: repeat(12, minmax(0, 1fr));
        }

        .card {
            position: relative;
            background: rgba(255, 255, 255, 0.9);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-sm);
            padding: 20px 22px;
            overflow: hidden;
        }

        .card::after {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.6), transparent 45%);
            opacity: 0.4;
            pointer-events: none;
        }

        .metric {
            grid-column: span 3;
            color: #0f172a;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            gap: 16px;
            min-height: 150px;
            padding: 24px 24px 20px;
        }

        .metric .metric-label {
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 0.4px;
            opacity: 0.9;
        }

        .metric .metric-value {
            font-size: 30px;
            font-weight: 700;
            letter-spacing: 0.6px;
            line-height: 1.1;
        }

        .metric .metric-sub {
            margin-top: 4px;
            font-size: 12px;
            opacity: 0.85;
        }

        .metric .metric-sub+.metric-sub {
            margin-top: 4px;
        }

        .metric[data-theme="blue"] {
            background: var(--gradient-blue);
            color: #f8fafc;
        }

        .metric[data-theme="indigo"] {
            background: var(--gradient-indigo);
            color: #f8f9ff;
        }

        .metric[data-theme="purple"] {
            background: var(--gradient-purple);
            color: #fdf4ff;
        }

        .metric[data-theme="pink"] {
            background: var(--gradient-pink);
            color: #fff5f7;
        }

        .metric[data-theme="orange"] {
            background: var(--gradient-orange);
            color: #fffdf2;
        }

        .metric[data-theme="lime"] {
            background: var(--gradient-lime);
            color: #f7fee7;
        }

        .metric[data-theme="cyan"] {
            background: var(--gradient-cyan);
            color: #ecfeff;
        }

        .metric[data-theme="slate"] {
            background: var(--gradient-slate);
            color: #f8fafc;
        }

        .metric[data-theme="teal"] {
            background: var(--gradient-teal);
            color: #ecfdf5;
        }

        .metric[data-theme="rose"] {
            background: var(--gradient-rose);
            color: #fff1f2;
        }

        .metric[data-theme="rose"] .metric-value {
            font-size: 26px;
            letter-spacing: 0.4px;
            line-height: 1.2;
        }

        .metric[data-key="version"] .metric-value span {
            display: block;
        }

        .metric.metric-time .metric-value {
            font-size: 24px;
            font-weight: 600;
            white-space: pre-line;
            font-variant-numeric: tabular-nums;
        }

        .metric.metric-time .metric-sub {
            font-size: 13px;
            letter-spacing: 0.2px;
            color: rgba(240, 253, 250, 0.92);
        }

        .metric.metric-time .metric-sub strong {
            font-weight: 600;
        }

        .metric::after {
            display: none;
        }

        .additions {
            grid-column: span 4;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .additions h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .addition-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .addition-list li {
            list-style: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            color: var(--text-muted);
            padding: 14px 12px;
            border-radius: 16px;
            background: rgba(148, 163, 184, 0.08);
        }

        .addition-list li span {
            font-size: 13px;
            letter-spacing: 0.4px;
        }

        .addition-list li strong {
            font-size: 22px;
            font-weight: 600;
            color: #0f172a;
        }

        .visuals {
            margin-top: 8px;
            align-items: stretch;
            gap: 12px;
        }

        .chart {
            grid-column: span 6;
            padding: 24px 24px 20px;
        }

        .chart .card-head {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 16px;
        }

        .chart-title {
            margin: 0;
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 0.4px;
        }

        .chart-head-main {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .chart-meta {
            font-size: 12px;
            color: var(--text-muted);
            display: inline-flex;
            gap: 6px;
            align-items: center;
            letter-spacing: 0.2px;
        }

        .chart-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            justify-content: flex-end;
        }

        .chip-group {
            display: inline-flex;
            padding: 4px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.32);
            gap: 4px;
            box-shadow: inset 0 0 0 1px rgba(15, 23, 42, 0.08);
        }

        .chip {
            border: none;
            border-radius: 999px;
            padding: 7px 16px;
            font-size: 12px;
            letter-spacing: 0.4px;
            color: #1e293b;
            background: transparent;
            cursor: pointer;
            transition: background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
        }

        .chip:hover {
            background: rgba(59, 130, 246, 0.15);
        }

        .chip.active {
            background: linear-gradient(135deg, #2563eb, #4f46e5);
            color: #f8fafc;
            box-shadow: 0 6px 14px rgba(37, 99, 235, 0.25);
            font-weight: 600;
        }

        .chart-canvas {
            border-radius: 12px;
            background: linear-gradient(180deg, rgba(59, 130, 246, 0.08), rgba(14, 165, 233, 0.04));
            padding: 12px;
            position: relative;
            width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
        }

        .chart-canvas canvas {
            display: block;
            height: auto;
        }

        .table {
            grid-column: span 6;
            display: flex;
            flex-direction: column;
            padding: 24px;
        }

        .table h3 {
            margin: 0 0 12px;
            font-size: 16px;
            font-weight: 600;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        thead tr {
            background: rgba(148, 163, 184, 0.1);
        }

        th,
        td {
            padding: 10px;
            text-align: left;
            color: #1f2937;
            border-bottom: 1px solid rgba(148, 163, 184, 0.18);
            white-space: nowrap;
        }

        th {
            font-weight: 600;
            color: var(--text-muted);
        }

        .btn {
            padding: 11px 18px;
            border-radius: 999px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 0.3px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn.primary {
            background: linear-gradient(135deg, #2563eb, #4f46e5);
            color: #f8fafc;
            box-shadow: 0 10px 20px rgba(37, 99, 235, 0.32);
        }

        .btn.secondary {
            background: rgba(59, 130, 246, 0.12);
            color: #1d4ed8;
        }

        .btn.compact {
            padding: 10px 20px;
            font-size: 13px;
            font-weight: 600;
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.25);
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .footer-bar {
            margin-top: 28px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            gap: 12px;
            align-items: center;
            padding: 16px 20px;
            border-radius: var(--card-radius);
            background: rgba(255, 255, 255, 0.88);
            box-shadow: var(--shadow-sm);
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            border-radius: 999px;
            background: linear-gradient(135deg, #1d4ed8, #3b82f6);
            color: #fff;
            text-decoration: none;
            font-size: 13px;
            font-weight: 600;
        }

        .muted {
            color: var(--text-muted);
            font-size: 13px;
        }

        @media (max-width: 1280px) {
            .metric {
                grid-column: span 4;
            }

            .chart,
            .table {
                grid-column: span 12;
            }
        }

        @media (max-width: 960px) {
            .metric {
                grid-column: span 6;
            }

            .chart,
            .table {
                grid-column: span 12;
            }
        }

        @media (max-width: 640px) {
            .wrap {
                padding: 24px 16px 40px;
            }

            .topbar h1 {
                font-size: 24px;
            }

            .surface {
                flex-direction: column;
                align-items: stretch;
            }

            .surface input {
                width: 100%;
            }

            .metric {
                grid-column: span 12;
            }

            .actions {
                flex-direction: column;
                align-items: stretch;
            }

            .actions .btn {
                width: 100%;
                text-align: center;
            }

            .chart-controls {
                justify-content: flex-start;
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="topbar">
            <h1>管理控制台
                <span>实时掌握用户、内容、文件与小游戏全局态势</span>
            </h1>
            <div class="surface search-card">
                <input id="search" placeholder="搜索卡片…" />
                <button class="btn secondary compact" id="btnUserManage">用户管理</button>
                <button class="btn primary compact" id="btnTerminalPage">终端页面</button>
            </div>
        </div>

        <div class="grid" id="totalGrid">
            <div class="card metric" data-key="totalUsers" data-theme="blue">
                <div class="metric-label">用户总数</div>
                <div class="metric-value">--</div>
                <div class="metric-sub">累计注册用户</div>
            </div>
            <div class="card metric" data-key="totalArticles" data-theme="indigo">
                <div class="metric-label">文章总数</div>
                <div class="metric-value">--</div>
                <div class="metric-sub">平台内容总量</div>
            </div>
            <div class="card metric" data-key="totalCollections" data-theme="purple">
                <div class="metric-label">收藏夹</div>
                <div class="metric-value">--</div>
                <div class="metric-sub">收藏夹总数</div>
            </div>
            <div class="card metric" data-key="totalCollectionItems" data-theme="pink">
                <div class="metric-label">收藏条目</div>
                <div class="metric-value">--</div>
                <div class="metric-sub">收藏内容数量</div>
            </div>
            <div class="card metric" data-key="totalReposts" data-theme="orange">
                <div class="metric-label">转发次数</div>
                <div class="metric-value">--</div>
                <div class="metric-sub">文章转发总计</div>
            </div>
            <div class="card metric" data-key="totalLikes" data-theme="lime">
                <div class="metric-label">点赞次数</div>
                <div class="metric-value">--</div>
                <div class="metric-sub">互动活跃指数</div>
            </div>
            <div class="card metric" data-key="totalFiles" data-theme="cyan">
                <div class="metric-label">文件总数</div>
                <div class="metric-value">--</div>
                <div class="metric-sub">文档 / 资料</div>
            </div>
            <div class="card metric" data-key="totalGame2048Score" data-theme="slate">
                <div class="metric-label">2048游戏用户数</div>
                <div class="metric-value">--</div>
                <div class="metric-sub">2048小游戏活跃数</div>
            </div>
            <div class="card metric" data-key="totalGameGuessScore" data-theme="indigo">
                <div class="metric-label">猜数字游戏用户数</div>
                <div class="metric-value">--</div>
                <div class="metric-sub">猜数小游戏活跃数</div>
            </div>
            <div class="card metric" data-key="totalGameMapTime" data-theme="orange">
                <div class="metric-label">地图游戏用户数</div>
                <div class="metric-value">--</div>
                <div class="metric-sub">地图游戏用户数</div>
            </div>
            <div class="card metric" data-key="version" data-theme="rose">
                <div class="metric-label">系统版本</div>
                <div class="metric-value">当前版本:<span id="versionText">--</span></div>
                <div class="metric-sub">本app版本号</div>
            </div>
            <div class="card metric metric-time" data-theme="teal">
                <div class="metric-label">后台时间</div>
                <div class="metric-value" id="metricCurrentTime">--</div>
                <div class="metric-sub" id="metricUptime">后台运行时长：--</div>
                <div class="metric-sub" id="metricStart">服务器启动时间：--</div>
            </div>
        </div>

        <div class="grid" style="margin-top: var(--gap);">
            <div class="card additions" data-section="users">
                <h3>用户新增</h3>
                <ul class="addition-list">
                    <li><span>近 7 天</span><strong data-period="7d">--</strong></li>
                    <li><span>近 3 个月</span><strong data-period="3m">--</strong></li>
                    <li><span>近 1 天</span><strong data-period="1d">--</strong></li>
                </ul>
            </div>
            <div class="card additions" data-section="files">
                <h3>文件新增</h3>
                <ul class="addition-list">
                    <li><span>近 7 天</span><strong data-period="7d">--</strong></li>
                    <li><span>近 3 个月</span><strong data-period="3m">--</strong></li>
                    <li><span>近 1 天</span><strong data-period="1d">--</strong></li>
                </ul>
            </div>
            <div class="card additions" data-section="articles">
                <h3>文章新增</h3>
                <ul class="addition-list">
                    <li><span>近 7 天</span><strong data-period="7d">--</strong></li>
                    <li><span>近 3 个月</span><strong data-period="3m">--</strong></li>
                    <li><span>近 1 天</span><strong data-period="1d">--</strong></li>
                </ul>
            </div>
        </div>

        <div class="grid visuals">
            <div class="card chart">
                <div class="card-head">
                    <div class="chart-head-main">
                        <h3 class="chart-title">新增趋势</h3>
                        <div class="chart-meta" id="chartMeta">--</div>
                    </div>
                    <div class="chart-controls">
                        <div class="chip-group" id="datasetChips" role="group" aria-label="数据类别">
                            <button type="button" class="chip active" data-dataset="users">用户新增</button>
                            <button type="button" class="chip" data-dataset="files">文件新增</button>
                            <button type="button" class="chip" data-dataset="articles">文章新增</button>
                        </div>
                        <div class="chip-group" id="rangeChips" role="group" aria-label="时间范围" data-default="7days">
                            <button type="button" class="chip active" data-range="7days">近 7 天</button>
                            <button type="button" class="chip" data-range="30days">近 30 天</button>
                            <button type="button" class="chip" data-range="6months">近 6 个月</button>
                        </div>
                        <button class="btn primary compact" id="btnRefresh">刷新趋势</button>
                    </div>
                </div>
                <div class="chart-canvas">
                    <canvas id="lineChart" aria-label="新增趋势折线图" role="img"></canvas>
                </div>
            </div>
            <div class="card table">
                <h3>最新的数据增量动态</h3>
                <table>
                    <thead>
                        <tr>
                            <th>时间</th>
                            <th>新增内容</th>
                            <th>数据量</th>
                            <th>描述</th>
                        </tr>
                    </thead>
                    <tbody id="recentTbody"></tbody>
                </table>
            </div>
        </div>

        <div class="footer-bar">
            <span class="muted">提示：/admin 路径已由后端中间件进行权限控制，请确保仅限管理员访问。</span>
            <a class="back-link" href="/page/shell" id="backLink">返回用户管理界面</a>
        </div>
    </div>

    <script>
        const chartCanvas = document.getElementById('lineChart');
        const totalGrid = document.getElementById('totalGrid');
        const searchInput = document.getElementById('search');
        const chartMetaEl = document.getElementById('chartMeta');
        const recentTbody = document.getElementById('recentTbody');
        const datasetChips = document.querySelectorAll('[data-dataset]');
        const rangeChips = document.querySelectorAll('[data-range]');
        const refreshBtn = document.getElementById('btnRefresh');
        const metricCurrentTimeEl = document.getElementById('metricCurrentTime');
        const metricUptimeEl = document.getElementById('metricUptime');
        const metricStartEl = document.getElementById('metricStart');
        const versionTextEl = document.getElementById('versionText');
        let latestChartData = null;
        let timeEventSource = null;
        let currentDataset = 'users';
        let currentRange = '7days';

        function formatNumber(num) {
            if (typeof num === 'string') return num;
            if (num === null || num === undefined || Number.isNaN(num)) return '--';
            if (num >= 1e9) return (num / 1e9).toFixed(1) + 'B';
            if (num >= 1e6) return (num / 1e6).toFixed(1) + 'M';
            if (num >= 1e3) return (num / 1e3).toFixed(1) + 'K';
            return Number(num).toLocaleString();
        }

        async function fetchJSON(url, options = {}, fallback = null) {
            try {
                const res = await fetch(url, { credentials: 'include', ...options });
                if (!res.ok) throw new Error(res.statusText);
                return await res.json();
            } catch (err) {
                console.warn('请求失败，使用兜底数据:', err);
                return typeof fallback === 'function' ? fallback() : fallback;
            }
        }

        function renderTotals(data) {
            if (!data) return;
            totalGrid.querySelectorAll('.metric').forEach(card => {
                const key = card.dataset.key;
                if (!key) return;
                const valueEl = card.querySelector('.metric-value');
                const formatted = formatNumber(data[key]);
                if (key === 'version' && versionTextEl) {
                    versionTextEl.textContent = formatted;
                } else {
                    valueEl.textContent = formatted;
                }
            });
        }

        function renderAdditions(data) {
            if (!data) return;
            const map = {
                users: data.user_add || [],
                files: data.files_add || [],
                articles: data.articles_add || []
            };
            document.querySelectorAll('.card.additions').forEach(section => {
                const key = section.dataset.section;
                const values = map[key] || [];
                const [v7 = 0, v3 = 0, v1 = 0] = values;
                section.querySelector('[data-period="7d"]').textContent = formatNumber(v7);
                section.querySelector('[data-period="3m"]').textContent = formatNumber(v3);
                section.querySelector('[data-period="1d"]').textContent = formatNumber(v1);
            });
        }

        function drawLineChart(canvas, series = [], labels = []) {
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const ratio = window.devicePixelRatio || 1;
            const container = canvas.parentElement;
            const baseWidth = container ? container.clientWidth - 24 : canvas.clientWidth || 600;
            const pointSpacing = 36;
            const dynamicWidth = Math.max(baseWidth, pointSpacing * Math.max(series.length - 1, 1) + 80);
            const width = dynamicWidth;
            const height = Math.max(240, Math.min(400, width * 0.5));

            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
            canvas.width = width * ratio;
            canvas.height = height * ratio;
            ctx.scale(ratio, ratio);
            ctx.clearRect(0, 0, width, height);

            if (!series.length || !labels.length) {
                ctx.fillStyle = '#94a3b8';
                ctx.font = '14px system-ui';
                ctx.textAlign = 'center';
                ctx.fillText('暂无数据', width / 2, height / 2);
                return;
            }

            const yLabelWidth = 50;
            const xLabelHeight = 40;
            const pad = { l: yLabelWidth, r: 20, t: 20, b: xLabelHeight };
            const innerW = width - pad.l - pad.r;
            const innerH = height - pad.t - pad.b;

            const minVal = Math.min(...series);
            const maxVal = Math.max(...series);
            const range = maxVal - minVal;
            const padding = range === 0
                ? Math.max(1, Math.ceil(maxVal * 0.2))
                : Math.max(1, Math.ceil(range * 0.15));
            const scaleMin = Math.max(0, Math.floor(minVal - padding));
            const scaleMax = Math.ceil(maxVal + padding);
            const stepCount = 5;

            ctx.strokeStyle = 'rgba(148, 163, 184, 0.4)';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(pad.l, pad.t);
            ctx.lineTo(pad.l, pad.t + innerH);
            ctx.lineTo(pad.l + innerW, pad.t + innerH);
            ctx.stroke();

            ctx.fillStyle = '#64748b';
            ctx.font = '12px system-ui';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            for (let i = 0; i <= stepCount; i++) {
                const val = scaleMin + (scaleMax - scaleMin) * (i / stepCount);
                const y = pad.t + innerH - innerH * (i / stepCount);
                ctx.globalAlpha = 0.25;
                ctx.beginPath();
                ctx.moveTo(pad.l, y);
                ctx.lineTo(pad.l + innerW, y);
                ctx.stroke();
                ctx.globalAlpha = 1;
                ctx.fillText(Math.round(val).toString(), pad.l - 8, y);
            }

            const gradient = ctx.createLinearGradient(pad.l, pad.t, pad.l, pad.t + innerH);
            gradient.addColorStop(0, 'rgba(59, 130, 246, 0.35)');
            gradient.addColorStop(1, 'rgba(103, 232, 249, 0.05)');

            ctx.beginPath();
            series.forEach((value, index) => {
                const x = pad.l + innerW * (index / (series.length - 1 || 1));
                const y = pad.t + innerH * (1 - (value - scaleMin) / (scaleMax - scaleMin || 1));
                if (index === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });

            ctx.strokeStyle = '#2563eb';
            ctx.lineWidth = 2.5;
            ctx.stroke();

            ctx.lineTo(pad.l + innerW, pad.t + innerH);
            ctx.lineTo(pad.l, pad.t + innerH);
            ctx.closePath();
            ctx.fillStyle = gradient;
            ctx.fill();

            ctx.fillStyle = '#475569';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            ctx.font = '12px system-ui';
            // 对于采样后的数据（最多12个点），显示所有标签
            labels.forEach((label, index) => {
                const x = pad.l + innerW * (index / (labels.length - 1 || 1));
                ctx.fillText(label, x, pad.t + innerH + 12);
            });
        }

        function renderRecent(list) {
            recentTbody.innerHTML = '';
            list.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${item.time}</td><td>${item.event}</td><td>${item.user}</td><td>${item.status}</td>`;
                recentTbody.appendChild(tr);
            });
        }

        function fallbackRecent() {
            const now = new Date();
            const fmt = (offsetMinutes) => {
                const d = new Date(now - offsetMinutes * 60000);
                return `${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
            };
            return [
                { time: fmt(18), event: '审核文章', user: 'Grace', status: '通过发布' },
                { time: fmt(42), event: '新增收藏夹', user: 'Leo', status: '创建成功' },
                { time: fmt(65), event: '上传文件', user: 'Mia', status: '文档中心' },
                { time: fmt(95), event: '小游戏挑战', user: 'Kai', status: '2048 得分 +1200' }
            ];
        }

        function fallbackCurve(rangeLabel) {
            const lengths = {
                '7days': 7,
                '30days': 30,
                '6months': 6
            };
            const unit = rangeLabel.includes('months') ? 'month' : 'day';
            const count = lengths[rangeLabel] || 30;
            const series = Array.from({ length: count }, () => Math.round(100 + Math.random() * 150));
            return {
                time_dimension: unit,
                data: series,
                data_length: series.length
            };
        }

        const monthPattern = /^\d{4}-(\d{1,2})$/;
        function normalizeLabels(dimension, labels) {
            if (dimension === 'month') {
                return labels.map(label => {
                    if (monthPattern.test(label)) {
                        const match = monthPattern.exec(label);
                        return `${Number(match?.[1] || 0)}月`;
                    }
                    const numeric = Number(label);
                    if (!Number.isNaN(numeric) && numeric >= 1 && numeric <= 12) {
                        return `${numeric}月`;
                    }
                    return label.includes('月') ? label : label;
                });
            }
            return labels;
        }

        async function loadCurve(table, range) {
            const payload = { table, time_range: range };
            const data = await fetchJSON('/api/dashboard/curve', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }, () => fallbackCurve(range));
            if (!data) return;
            const dataLength = data.data ? data.data.length : (data.data_length || 0);
            const rawLabels = (data.labels && data.labels.length === dataLength)
                ? data.labels
                : buildLabels(data.time_dimension, dataLength);
            const normalizedLabels = normalizeLabels(data.time_dimension, rawLabels);
            const series = data.data || [];
            if (normalizedLabels.length !== series.length) {
                console.warn('标签数量与数据数量不匹配，调整标签数量');
                const minLen = Math.min(normalizedLabels.length, series.length);
                latestChartData = {
                    labels: normalizedLabels.slice(0, minLen),
                    series: series.slice(0, minLen)
                };
            } else {
                latestChartData = { labels: normalizedLabels, series: series };
            }
            drawLineChart(chartCanvas, latestChartData.series, latestChartData.labels);
            chartMetaEl.textContent = `当前数据指标：${table} \n 数据维度：${data.time_dimension}  \n总的数据点数: ${latestChartData.labels.length}`;
        }

        function buildLabels(dimension, length) {
            const labels = [];
            const now = new Date();
            for (let i = length - 1; i >= 0; i--) {
                if (dimension === 'day') {
                    const d = new Date(now - i * 86400000);
                    labels.push(`${d.getMonth() + 1}/${d.getDate()}`);
                } else if (dimension === 'month') {
                    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    labels.push(`${d.getMonth() + 1}月`);
                } else {
                    labels.push(`${now.getFullYear() - i}`);
                }
            }
            return labels;
        }

        function initTimeStream() {
            if (!metricCurrentTimeEl || timeEventSource) return;
            if (!window.EventSource) {
                const fallback = new Date().toLocaleString().replace(' ', '\n');
                metricCurrentTimeEl.textContent = fallback;
                metricUptimeEl.innerHTML = '运行时长：<strong>浏览器不支持 SSE</strong>';
                metricStartEl.innerHTML = '启动时间：<strong>--</strong>';
                return;
            }
            timeEventSource = new EventSource('/api/dashboard/time/sse', { withCredentials: true });
            const updateTime = (event) => {
                try {
                    const payload = JSON.parse(event.data || '{}');
                    const currentTime = (payload.currentTime || '--').replace(' ', '\n');
                    metricCurrentTimeEl.textContent = currentTime;
                    metricUptimeEl.innerHTML = `运行时长：<strong>${payload.systemUptime || '--'}</strong>`;
                    metricStartEl.innerHTML = `启动时间：<strong>${payload.startTime || '--'}</strong>`;
                } catch (err) {
                    console.warn('解析时间数据失败:', err);
                }
            };
            timeEventSource.addEventListener('tick', updateTime);
            timeEventSource.onerror = () => {
                metricUptimeEl.innerHTML = '运行时长：<strong>连接中断，重试中…</strong>';
            };
        }

        function setActiveChip(chips, attr, value) {
            chips.forEach(btn => {
                const isActive = btn.dataset[attr] === value;
                btn.classList.toggle('active', isActive);
            });
        }

        function registerInteractions() {
            setActiveChip(datasetChips, 'dataset', currentDataset);
            setActiveChip(rangeChips, 'range', currentRange);

            datasetChips.forEach(btn => {
                btn.addEventListener('click', () => {
                    const val = btn.dataset.dataset;
                    if (!val || val === currentDataset) return;
                    currentDataset = val;
                    setActiveChip(datasetChips, 'dataset', currentDataset);
                    loadCurve(currentDataset, currentRange);
                });
            });

            rangeChips.forEach(btn => {
                btn.addEventListener('click', () => {
                    const val = btn.dataset.range;
                    if (!val || val === currentRange) return;
                    currentRange = val;
                    setActiveChip(rangeChips, 'range', currentRange);
                    loadCurve(currentDataset, currentRange);
                });
            });

            searchInput.addEventListener('input', () => {
                const keyword = searchInput.value.trim().toLowerCase();
                totalGrid.querySelectorAll('.metric').forEach(card => {
                    const text = card.innerText.toLowerCase();
                    card.style.opacity = keyword && !text.includes(keyword) ? 0.25 : 1;
                    card.style.transform = keyword && text.includes(keyword) ? 'scale(1.02)' : '';
                });
            });

            window.addEventListener('resize', () => {
                if (latestChartData) {
                    drawLineChart(chartCanvas, latestChartData.series, latestChartData.labels);
                }
            });
        }

        async function bootstrap() {
            const [totals, additions] = await Promise.all([
                fetchJSON('/api/dashboard/total', {}, null),
                fetchJSON('/api/dashboard/add', {}, null)
            ]);
            renderTotals(totals);
            renderAdditions(additions);

            const recent = additions ? buildRecentFromAdditions(additions) : fallbackRecent();
            renderRecent(recent);

            await loadCurve(currentDataset, currentRange);
        }

        function buildRecentFromAdditions(additions) {
            const entries = [];
            const map = [
                { type: '用户', arr: additions.user_add, icon: '新增用户' },
                { type: '文件', arr: additions.files_add, icon: '上传文件' },
                { type: '文章', arr: additions.articles_add, icon: '发布文章' }
            ];
            const labels = ['近 7 天', '近 3 个月', '近 1 天'];
            const now = new Date();
            map.forEach(item => {
                if (!item.arr) return;
                item.arr.forEach((val, idx) => {
                    entries.push({
                        time: `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`,
                        event: `${item.icon}`,
                        user: item.type,
                        status: `${labels[idx]}：${formatNumber(val)}`
                    });
                });
            });
            return entries.length ? entries : fallbackRecent();
        }

        registerInteractions();
        document.addEventListener('click', (event) => {
            const target = event.target;
            if (!(target instanceof HTMLElement)) return;
            if (target.id === 'btnUserManage') {
                event.preventDefault();
                location.assign('/admin/users');
            } else if (target.id === 'btnTerminalPage') {
                event.preventDefault();
                window.open('/admin/superadmin/terminal', '_blank', 'noopener');
            }
        });
        initTimeStream();
        window.addEventListener('beforeunload', () => {
            if (timeEventSource) {
                timeEventSource.close();
            }
        });
        bootstrap();
    </script>
</body>

</html>