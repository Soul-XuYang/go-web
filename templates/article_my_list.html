<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººæ–‡ç« ç®¡ç†</title>
    <link rel="stylesheet" href="/static/my_articles.css">
</head>

<body>
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <nav class="zhihu-nav">
        <div class="zhihu-nav-inner">
            <h1 class="zhihu-nav-title">ä¸ªäººæ–‡ç« ç®¡ç†</h1>
            <div class="zhihu-user-info">
                <div class="zhihu-user-avatar" id="userAvatar">U</div>
                <span class="zhihu-username" id="username">åŠ è½½ä¸­...</span>
            </div>
        </div>
    </nav>

    <!-- ä¸»å®¹å™¨ -->
    <div class="zhihu-container">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="zhihu-stats">
            <div class="zhihu-stat-card">
                <div class="zhihu-stat-label">ğŸ“ æ–‡ç« æ€»æ•°</div>
                <div class="zhihu-stat-value" id="statTotal">0</div>
            </div>
            <div class="zhihu-stat-card">
                <div class="zhihu-stat-label">ğŸ‘ æ€»ç‚¹èµæ•°</div>
                <div class="zhihu-stat-value" id="statLikes">0</div>
            </div>
            <div class="zhihu-stat-card">
                <div class="zhihu-stat-label">ğŸ’¬ æ€»è¯„è®ºæ•°</div>
                <div class="zhihu-stat-value" id="statComments">0</div>
            </div>
        </div>

        <!-- æ“ä½œå·¥å…·æ  -->
        <div class="zhihu-toolbar">
            <div class="zhihu-toolbar-left">
                <a href="/page/articles" class="zhihu-btn">è¿”å›è®ºå›ç•Œé¢</a>
                <a href="/page/shell" class="zhihu-btn">è¿”å›ä¸»åº”ç”¨ç•Œé¢</a>
                <a href="/page/articles/create" class="zhihu-btn zhihu-btn-primary">âœï¸ åˆ›å»ºæ–°æ–‡ç« </a>
                <button class="zhihu-btn" id="btnRefresh">ğŸ”„ åˆ·æ–°</button>
            </div>
            <div class="zhihu-toolbar-right">
                <span class="zhihu-sort-label">æ’åºï¼š</span>
                <select class="zhihu-sort-select" id="orderSelect">
                    <option value="created_desc">åˆ›å»ºæ—¶é—´ï¼ˆæ–°â†’æ—§ï¼‰</option>
                    <option value="created_asc">åˆ›å»ºæ—¶é—´ï¼ˆæ—§â†’æ–°ï¼‰</option>
                    <option value="likes_desc">ç‚¹èµæ•°ï¼ˆé«˜â†’ä½ï¼‰</option>
                    <option value="likes_asc">ç‚¹èµæ•°ï¼ˆä½â†’é«˜ï¼‰</option>
                    <option value="comments_desc">è¯„è®ºæ•°ï¼ˆé«˜â†’ä½ï¼‰</option>
                    <option value="comments_asc">è¯„è®ºæ•°ï¼ˆä½â†’é«˜ï¼‰</option>
                </select>
            </div>
        </div>

        <!-- æ–‡ç« åˆ—è¡¨ -->
        <div class="zhihu-article-list" id="articleList">
            <div class="zhihu-loading">åŠ è½½ä¸­...</div>
        </div>
    </div>

    <script>
        const $ = s => document.querySelector(s);

        function getStoredToken() {
            const t = localStorage.getItem('token');
            return t ? (t.toLowerCase().startsWith('bearer ') ? t : 'Bearer ' + t) : null;
        }

        async function authFetch(url, opts = {}) {
            const token = getStoredToken();
            const headers = Object.assign(
                { 'Content-Type': 'application/json' },
                token ? { 'Authorization': token } : {},
                opts.headers || {}
            );
            const r = await fetch(url, { ...opts, headers });
            if (r.status === 401) {
                localStorage.removeItem('token');
                location.href = '/auth/login';
                throw new Error('Unauthorized');
            }
            return r;
        }

        function escapeHTML(s) {
            const div = document.createElement('div');
            div.textContent = s ?? '';
            return div.innerHTML;
        }

        // åŠ è½½ç”¨æˆ·ä¿¡æ¯
        async function loadMe() {
            try {
                const r = await authFetch('/api/me', { cache: 'no-store' });
                const d = await r.json().catch(() => ({}));
                const u = d.username || 'unknown';
                $('#username').textContent = u;
                $('#userAvatar').textContent = (u?.trim?.()[0] || 'U').toUpperCase();
            } catch (e) {
                console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e);
            }
        }

        // åŠ è½½æ–‡ç« åˆ—è¡¨
        async function loadArticles() {
            const order = $('#orderSelect').value || 'created_desc';
            const container = $('#articleList');
            container.innerHTML = '<div class="zhihu-loading">åŠ è½½ä¸­...</div>';

            try {
                const url = `/api/articles/me?order=${order}&page_size=100`;
                const r = await authFetch(url, { cache: 'no-store' });
                const articles = await r.json();

                if (!Array.isArray(articles) || articles.length === 0) {
                    container.innerHTML = `
                        <div class="zhihu-empty">
                            <div class="zhihu-empty-icon">ğŸ“</div>
                            <div>è¿˜æ²¡æœ‰æ–‡ç« ï¼Œ<a href="/page/articles/create" style="color:#0084ff;">ç«‹å³åˆ›å»º</a>å§ï¼</div>
                        </div>
                    `;
                    updateStats([]);
                    return;
                }

                renderArticles(articles);
                updateStats(articles);
            } catch (e) {
                container.innerHTML = `<div class="zhihu-error">åŠ è½½å¤±è´¥ï¼š${e.message}</div>`;
            }
        }

        // æ¸²æŸ“æ–‡ç« åˆ—è¡¨
        function renderArticles(articles) {
            const container = $('#articleList');
            container.innerHTML = '';

            articles.forEach(article => {
                const card = document.createElement('div');
                card.className = 'zhihu-my-article-card';

                card.innerHTML = `
                    <div class="zhihu-article-header">
                        <div class="zhihu-article-main">
                            <h2 class="zhihu-article-title" onclick="viewArticle(${article.id})">
                        ${escapeHTML(article.title)}
                            </h2>
                            <p class="zhihu-article-preview">${escapeHTML(article.preview || '')}</p>
                            <div class="zhihu-article-meta">
                                <div class="zhihu-meta-item">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path>
                                    </svg>
                                    <span>${article.likes || 0}</span>
                                </div>
                                <div class="zhihu-meta-item">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                    </svg>
                                    <span>${article.commentcount || 0}</span>
                                </div>
                                <div class="zhihu-meta-item">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                        <circle cx="18" cy="5" r="3"></circle>
                                        <circle cx="6" cy="12" r="3"></circle>
                                        <circle cx="18" cy="19" r="3"></circle>
                                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                                    </svg>
                                    <span>${article.repost_count || 0}</span>
                                </div>
                                <span>Â·</span>
                                <span>åˆ›å»ºäº ${article.created_at || '-'}</span>
                                ${article.updated_at && article.updated_at !== article.created_at
                        ? `<span>Â·</span><span>æ›´æ–°äº ${article.updated_at}</span>`
                        : ''}
                            </div>
                        </div>
                        <div class="zhihu-article-actions">
                            <button class="zhihu-article-btn view" onclick="viewArticle(${article.id})" title="æŸ¥çœ‹">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                    <circle cx="12" cy="12" r="3"></circle>
                                </svg>
                            </button>
                            <button class="zhihu-article-btn edit" onclick="editArticle(${article.id})" title="ç¼–è¾‘">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            <button class="zhihu-article-btn delete" onclick="deleteArticle(${article.id}, '${escapeHTML(article.title).replace(/'/g, "&#39;")}')" title="åˆ é™¤">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats(articles) {
            const total = articles.length;
            const likes = articles.reduce((sum, a) => sum + (a.likes || 0), 0);
            const comments = articles.reduce((sum, a) => sum + (a.commentcount || 0), 0);

            $('#statTotal').textContent = total;
            $('#statLikes').textContent = likes;
            $('#statComments').textContent = comments;
        }

        // æŸ¥çœ‹æ–‡ç« 
        window.viewArticle = function (id) {
            location.href = `/page/articles/${id}`;
        };

        // ç¼–è¾‘æ–‡ç« 
        window.editArticle = function (id) {
            location.href = `/page/articles/edit/${id}`;
        };

        // åˆ é™¤æ–‡ç« 
        window.deleteArticle = async function (id, title) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ç« ã€Š${title}ã€‹å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }

            try {
                const r = await authFetch(`/api/articles/${id}`, {
                    method: 'DELETE'
                });

                if (r.ok) {
                    alert('æ–‡ç« å·²åˆ é™¤');
                    loadArticles();
                } else {
                    const err = await r.json();
                    alert('åˆ é™¤å¤±è´¥ï¼š' + (err.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (e) {
                alert('åˆ é™¤å¤±è´¥ï¼š' + (e.message || 'ç½‘ç»œé”™è¯¯'));
            }
        };

        // äº‹ä»¶ç»‘å®š
        $('#btnRefresh').onclick = loadArticles;
        $('#orderSelect').onchange = loadArticles;

        // é¡µé¢åŠ è½½
        loadMe();
        loadArticles();
    </script>
</body>

</html>